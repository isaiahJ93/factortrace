import jsPDF from 'jspdf';
import 'jspdf-autotable';

// Design constants for PDF styling
const DESIGN = {
  colors: {
    primary: [26, 26, 46] as [number, number, number],
    secondary: [100, 100, 100] as [number, number, number],
    text: [50, 50, 50] as [number, number, number],
    success: [16, 185, 129] as [number, number, number],
    warning: [245, 158, 11] as [number, number, number],
    error: [239, 68, 68] as [number, number, number]
  },
  fonts: {
    sizes: {
      title: 16,
      subtitle: 14,
      body: 11,
      small: 10,
      tiny: 9
    }
  },
  layout: {
    margins: {
      top: 20,
      bottom: 20,
      left: 20,
      right: 20
    },
    pageHeight: 297,
    pageWidth: 210
  }
};

// Interfaces
export interface PDFExportData {
  metadata: {
    documentId?: string;
    companyName: string;
    reportingPeriod: string;
    generatedDate: string;
    standard?: string;
    methodology?: string;
  };
  summary: {
    totalEmissions: number;
    scope1: number;
    scope2: number;
    scope3: number;
    scope1Percentage?: number;
    scope2Percentage?: number;
    scope3Percentage?: number;
    dataQualityScore?: number;
  };
  governance?: any;
  targets?: any[];
  activities?: any[];
  scope3Categories?: any[];
  topEmissionSources?: any[];
  [key: string]: any;
}

export interface ExportResult {
  success: boolean;
  blob: Blob | null;
  error?: string;
}

/**
 * PDF Export Handler for ESRS E1 compliant reports
 */
export class PDFExportHandler {
  private static instance: PDFExportHandler;
  private readonly apiUrl: string;
  
  private constructor(apiUrl: string = 'http://localhost:8000') {
    this.apiUrl = apiUrl;
  }
  
  public static getInstance(apiUrl?: string): PDFExportHandler {
    if (!PDFExportHandler.instance) {
      PDFExportHandler.instance = new PDFExportHandler(apiUrl);
    }
    return PDFExportHandler.instance;
  }
  
  /**
   * Export a single PDF with all emission data
   */
  public async exportSinglePDF(
    data: PDFExportData,
    options?: { useBackend?: boolean; filename?: string; compress?: boolean; validate?: boolean }
  ): Promise<ExportResult> {
    try {
      console.log('Generating PDF with data:', data);
      
      // Validate data
      if (!data || !data.metadata || !data.summary) {
        throw new Error('Invalid data structure for PDF export');
      }
      
      // Create PDF
      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4',
        compress: options?.compress || false
      });
      
      // Generate PDF content
      const pdfBlob = await this.generatePDFClient(data, options?.compress || false);
      
      // Download if filename provided
      if (options?.filename) {
        this.downloadBlob(pdfBlob, options.filename);
      }
      
      return { success: true, blob: pdfBlob };
    } catch (error) {
      console.error('PDF export failed:', error);
      return { 
        success: false, 
        blob: null, 
        error: error instanceof Error ? error.message : 'Export failed' 
      };
    }
  }
  
  /**
   * Generate PDF on client side
   */
  private async generatePDFClient(data: PDFExportData, compress: boolean): Promise<Blob> {
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4',
      compress
    });
    
    let currentY = 20;
    
    // Add header
    if (typeof this.addHeader === 'function') {
      this.addHeader(pdf, data);
    }
    
    // Add title
    pdf.setFontSize(20);
    pdf.setTextColor(26, 26, 46);
    pdf.text(data.metadata.companyName || 'Company Report', 20, currentY);
    currentY += 10;
    
    pdf.setFontSize(14);
    pdf.text('ESRS E1 Climate-related Disclosures', 20, currentY);
    currentY += 15;
    
    // Add summary
    pdf.setFontSize(12);
    pdf.text('Executive Summary', 20, currentY);
    currentY += 8;
    
    pdf.setFontSize(10);
    pdf.text('Total Emissions: ' + data.summary.totalEmissions.toFixed(2) + ' tCO2e', 20, currentY);
    currentY += 6;
    pdf.text('Scope 1: ' + data.summary.scope1.toFixed(2) + ' tCO2e', 20, currentY);
    currentY += 6;
    pdf.text('Scope 2: ' + data.summary.scope2.toFixed(2) + ' tCO2e', 20, currentY);
    currentY += 6;
    pdf.text('Scope 3: ' + data.summary.scope3.toFixed(2) + ' tCO2e', 20, currentY);
    currentY += 6;
    pdf.text('Data Quality Score: ' + (data.summary.dataQualityScore || 72) + '%', 20, currentY);
    
    // Add more sections if the methods exist
    if (typeof this.addReportInfo === 'function') {
      pdf.addPage();
      currentY = 20;
      currentY = this.addReportInfo(pdf, data, currentY);
    }
    
    if (typeof this.addExecutiveSummary === 'function' && currentY < 250) {
      currentY = this.addExecutiveSummary(pdf, data, currentY + 10);
    }
    
    if (typeof this.addEmissionsOverview === 'function') {
      pdf.addPage();
      currentY = 20;
      currentY = this.addEmissionsOverview(pdf, data, currentY);
    }
    
    // Add footers
    if (typeof this.addFooters === 'function') {
      this.addFooters(pdf, data);
    }
    
    return pdf.output('blob');
  }
  
  /**
   * Download blob as file
   */
  private downloadBlob(blob: Blob, filename: string): void {
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.click();
    URL.revokeObjectURL(url);
  }
}

export async function generatePDFReport(
  data: PDFExportData,
  options?: { useBackend?: boolean; filename?: string; compress?: boolean; validate?: boolean }
): Promise<ExportResult> {
  const handler = PDFExportHandler.getInstance();
  return handler.exportSinglePDF(data, options);
}
