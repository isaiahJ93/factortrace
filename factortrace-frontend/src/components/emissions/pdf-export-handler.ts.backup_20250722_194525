/**
 * Professional PDF Export Handler - Enterprise Production Edition
 * ==============================================================
 * 
 * A production-ready PDF generation system for GHG emissions reporting
 * following ESRS E1 compliance standards with robust data validation.
 * 
 * DATA CONSISTENCY PRINCIPLES:
 * 1. Summary data (scope1, scope2, scope3, totalEmissions) is the SOURCE OF TRUTH
 * 2. Activities are used for detailed breakdowns only, not for recalculation
 * 3. All totals throughout the PDF match the summary data
 * 4. Percentages are recalculated to ensure they sum to 100%
 * 
 * EMISSIONS CALCULATION:
 * The PDF handler assumes emissions = (amount * factor) / 1000
 * If your main app uses a different formula, update the calculation in:
 * - processScope3Data() method
 * - getScope1Breakdown() method
 * - addActivityDetails() method
 * 
 * GOVERNANCE DATA:
 * Board oversight, transition plans, and targets shown in the PDF are placeholders.
 * In production, pass actual data via governanceData and transitionPlan objects.
 * 
 * @author Dr. Samantha Voronova-Patel
 * @version 3.1.0
 * @license MIT
 */

import jsPDF from 'jspdf';
import 'jspdf-autotable';
import html2canvas from 'html2canvas';
import { useState } from 'react';

// Extend jsPDF type for autoTable
declare module 'jspdf' {
  interface jsPDF {
    autoTable: (options: any) => jsPDF;
    lastAutoTable: { finalY: number };
  }
}

// Enhanced type definitions with validation
interface EmissionActivity {
  id?: string;
  name: string;
  categoryName: string;
  scopeCategory?: string; // "scope1", "scope2", "scope3"
  amount: number | string;
  unit: string;
  factor: number | string;
  emissions?: number | string;
  evidence?: Array<{
    id: string;
    filename: string;
    type: string;
  }>;
  dataQuality?: 'high' | 'medium' | 'low';
  calculationMethod?: string;
}

interface Scope3Category {
  category: string;
  categoryNumber: number;
  emissions: number;
  activities: number;
  hasEvidence: boolean;
  percentage: number;
  dataQuality: string;
  calculationMethod: string;
  applicabilityStatus?: 'applicable' | 'not-applicable' | 'de-minimis';
  notApplicableReason?: string;
}

interface PDFExportData {
  metadata: {
    reportTitle: string;
    companyName: string;
    reportingPeriod: string;
    generatedDate: string;
    documentId: string;
    standard?: string;
    methodology?: string;
    preparedBy?: string;
    reviewedBy?: string;
    version?: string;
  };
  summary: {
    totalEmissions: number;
    scope1: number;
    scope2: number;
    scope2Market?: number;
    scope3: number;
    scope1Percentage: number;
    scope2Percentage: number;
    scope3Percentage: number;
    dataQualityScore: number;
    evidenceCount: number;
    calculationCompleteness?: number;
  };
  topEmissionSources: Array<{
    name: string;
    category: string;
    emissions: number;
    percentage: number;
  }>;
  scope3Analysis?: Scope3Category[];
  activities?: EmissionActivity[];
  evidenceFiles?: any[];
  uncertaintyAnalysis?: any;
  dataQuality?: any;
  chartElements?: HTMLElement[];
  companyProfile?: {
    sector: string;
    employees: number;
    revenue?: number;
    operations?: string[];
  };
  governanceData?: {
    boardOversight?: string;
    boardMeetingFrequency?: string;
    managementResponsibilities?: string;
  };
  transitionPlan?: {
    adopted?: boolean;
    alignedWith15C?: boolean;
    details?: string;
  };
}

interface BulkExportOptions {
  documents: PDFExportData[];
  onProgress?: (progress: number, currentDoc: string) => void;
  onComplete?: (results: ExportResult[]) => void;
  parallelLimit?: number;
  retryAttempts?: number;
  compressionLevel?: 'none' | 'fast' | 'best';
  apiUrl?: string;
}

interface ExportResult {
  success: boolean;
  documentId: string;
  filename: string;
  size?: number;
  error?: string;
  timestamp?: string;
}

// Professional Design System
const DESIGN = {
  colors: {
    // Primary palette
    darkGreen: { r: 46, g: 125, b: 50 },     // #2E7D32
    green: { r: 76, g: 175, b: 80 },         // #4CAF50
    lightGreen: { r: 232, g: 245, b: 233 },  // #E8F5E9
    
    // Text hierarchy
    black: { r: 0, g: 0, b: 0 },             // #000000
    darkGray: { r: 66, g: 66, b: 66 },       // #424242
    gray: { r: 117, g: 117, b: 117 },        // #757575
    lightGray: { r: 224, g: 224, b: 224 },   // #E0E0E0
    
    // Background
    white: { r: 255, g: 255, b: 255 },       // #FFFFFF
    offWhite: { r: 250, g: 250, b: 250 },    // #FAFAFA
    
    // Status colors
    error: { r: 211, g: 47, b: 47 },         // #D32F2F
    warning: { r: 245, g: 124, b: 0 },       // #F57C00
    success: { r: 56, g: 142, b: 60 }        // #388E3C
  },
  typography: {
    fonts: {
      primary: 'helvetica',
      mono: 'courier'
    },
    sizes: {
      h1: 16,
      h2: 14,
      h3: 12,
      body: 10,
      small: 9,
      tiny: 8,
      micro: 7
    }
  },
  layout: {
    margins: {
      top: 25,
      right: 15,
      bottom: 20,
      left: 15
    },
    spacing: {
      section: 15,
      subsection: 10,
      paragraph: 8,
      line: 6
    }
  }
};

// Scope 3 Category Definitions
const SCOPE3_CATEGORIES = [
  { num: 1, name: 'Purchased goods and services', defaultMethod: 'Spend-based' },
  { num: 2, name: 'Capital goods', defaultMethod: 'Average-data' },
  { num: 3, name: 'Fuel- and energy-related activities', defaultMethod: 'Average-data' },
  { num: 4, name: 'Upstream transportation and distribution', defaultMethod: 'Distance-based' },
  { num: 5, name: 'Waste generated in operations', defaultMethod: 'Waste-type-specific' },
  { num: 6, name: 'Business travel', defaultMethod: 'Distance-based' },
  { num: 7, name: 'Employee commuting', defaultMethod: 'Distance-based' },
  { num: 8, name: 'Upstream leased assets', defaultMethod: 'Asset-specific' },
  { num: 9, name: 'Downstream transportation and distribution', defaultMethod: 'Distance-based' },
  { num: 10, name: 'Processing of sold products', defaultMethod: 'Average-data' },
  { num: 11, name: 'Use of sold products', defaultMethod: 'Direct use-phase' },
  { num: 12, name: 'End-of-life treatment of sold products', defaultMethod: 'Waste-type-specific' },
  { num: 13, name: 'Downstream leased assets', defaultMethod: 'Asset-specific' },
  { num: 14, name: 'Franchises', defaultMethod: 'Franchise-specific' },
  { num: 15, name: 'Investments', defaultMethod: 'Investment-specific' }
];
  /**
   * Enhanced header with status indicators
   */
  private addHeader(pdf: jsPDF, data: PDFExportData): void {
    const pageWidth = pdf.internal.pageSize.getWidth();
    const documentId = data.metadata.documentId || 'GHG-' + Date.now().toString(36).toUpperCase();
    const currentDate = new Date().toLocaleDateString('en-GB');
    const companyName = data.metadata.companyName || 'Your Company';
    const totalEmissions = data.summary.totalEmissions.toFixed(1);
    
    // Header text
    pdf.setFontSize(8);
    pdf.setTextColor(100, 100, 100);
    
    // Left side
    pdf.text(documentId + ' | ' + currentDate, 20, 9);
    
    // Right side  
    pdf.text(companyName + ' ESRS E1 | ' + totalEmissions + ' tCO2e', pageWidth - 20, 9, { align: 'right' });
    
    // Header line
    pdf.setDrawColor(200, 200, 200);
    pdf.setLineWidth(0.5);
    pdf.line(20, 12, pageWidth - 20, 12);
  }

  /**
   * Add document title
   */
  private addTitle(pdf: jsPDF, data: PDFExportData, y: number): number {
    const { colors, typography } = DESIGN;
    
    pdf.setFontSize(typography.sizes.h1);
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    pdf.setFont(typography.fonts.primary, 'bold');
    
    const title = '' + data.metadata.companyName + ' - ESRS E1 Climate-related Disclosures';
    pdf.text(title, DESIGN.layout.margins.left, y);
    
    // Professional underline
    const titleWidth = pdf.getTextWidth(title);
    pdf.setDrawColor(colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b);
    pdf.setLineWidth(1);
    pdf.line(DESIGN.layout.margins.left, y + 2, DESIGN.layout.margins.left + titleWidth, y + 2);
    
    return y + 15;
  }

  /**
   * Add report information section
   */
  private addReportInfo(pdf: jsPDF, data: PDFExportData, y: number): number {
    const { colors, typography } = DESIGN;
    
    pdf.setFontSize(typography.sizes.h2);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    pdf.text('Report Information', DESIGN.layout.margins.left, y);
    
    y += 10;
    
    const pageWidth = 210;
    const boxWidth = pageWidth - DESIGN.layout.margins.left - DESIGN.layout.margins.right;
    pdf.setFillColor(colors.offWhite.r, colors.offWhite.g, colors.offWhite.b);
    pdf.rect(DESIGN.layout.margins.left, y - 5, boxWidth, 35, 'F');
    
    pdf.setFontSize(typography.sizes.body);
    pdf.setFont(typography.fonts.primary, 'normal');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    
    const info = [
      'Reporting Period: ' + data.metadata.reportingPeriod + '',
      'Publication Date: ' + new Date(data.metadata.generatedDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
      'Standard Applied: ' + data.metadata.standard || 'ESRS E1, GHG Protocol Corporate Value Chain (Scope 3) Standard',
      'Methodology: ' + data.metadata.methodology || 'Activity-based and spend-based hybrid approach' + ''
    ];
    
    info.forEach((line, index) => {
      pdf.text(line, DESIGN.layout.margins.left + 5, y + (index * 6));
    });
    
    return y + 40;
  }

  /**
   * Add executive summary section
   */
  private addExecutiveSummary(pdf: jsPDF, data: PDFExportData, y: number): number {
    const { colors, typography, layout } = DESIGN;
    
    // Section header
    pdf.setFontSize(typography.sizes.h2);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b);
    pdf.text('Executive Summary', layout.margins.left, y);
    
    y += layout.spacing.subsection;
    
    // Key metrics box
    const boxHeight = 35;
    const pageWidth = 210;
    const boxWidth = pageWidth - layout.margins.left - layout.margins.right;
    
    // Green gradient background
    pdf.setFillColor(colors.lightGreen.r, colors.lightGreen.g, colors.lightGreen.b);
    pdf.rect(layout.margins.left, y - 5, boxWidth, boxHeight, 'F');
    
    // Metrics
    pdf.setFontSize(typography.sizes.small);
    pdf.setFont(typography.fonts.primary, 'normal');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    
    const col1X = layout.margins.left + 5;
    const col2X = layout.margins.left + boxWidth / 2;
    let lineY = y;
    
    // Column 1
    pdf.text('Total Emissions: ' + data.summary.totalEmissions.toFixed(2) + ' tCO2e', col1X, lineY);
    lineY += layout.spacing.line;
    const qualityScore = data.summary.dataQualityScore || this.calculateDataQuality(data);
    pdf.text('Data Quality Score: ' + Math.round(qualityScore) + '%', col1X, lineY);
    lineY += layout.spacing.line;
    pdf.text('Evidence Documents: ' + data.summary.evidenceCount || 0 + '', col1X, lineY);
    
    // Column 2
    lineY = y;
    pdf.text('Scope 1: ' + data.summary.scope1.toFixed(2) + ' tCO2e (' + data.summary.scope1Percentage.toFixed(0) + '%)', col2X, lineY);
    lineY += layout.spacing.line;
    pdf.text('Scope 2: ' + data.summary.scope2.toFixed(2) + ' tCO2e (' + data.summary.scope2Percentage.toFixed(0) + '%)', col2X, lineY);
    lineY += layout.spacing.line;
    pdf.text('Scope 3: ' + data.summary.scope3.toFixed(2) + ' tCO2e (' + data.summary.scope3Percentage.toFixed(0) + '%)', col2X, lineY);
    
    return y + boxHeight + layout.spacing.section;
  }

  /**
   * Add ESRS 2 section
   */
  private addESRS2Section(pdf: jsPDF, y: number, data?: PDFExportData): number {
    const { colors, typography } = DESIGN;
    
    pdf.setFontSize(typography.sizes.h2);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    pdf.text('ESRS 2 - General Disclosures', DESIGN.layout.margins.left, y);
    
    y += 10;
    
    const pageWidth = 210;
    const boxWidth = pageWidth - DESIGN.layout.margins.left - DESIGN.layout.margins.right;
    pdf.setFillColor(colors.lightGreen.r, colors.lightGreen.g, colors.lightGreen.b);
    pdf.rect(DESIGN.layout.margins.left, y - 5, boxWidth, 28, 'F');
    
    pdf.setFontSize(typography.sizes.body);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b);
    pdf.text('GOV-1: The role of governance bodies', DESIGN.layout.margins.left + 5, y);
    
    pdf.setFont(typography.fonts.primary, 'normal');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    
    // Use actual data if available, otherwise show placeholder
    const boardOversight = (data && data.governanceData?.boardOversight) || 'Confirmed';
    const boardFrequency = (data && data.governanceData?.boardMeetingFrequency) || 'Quarterly';
    const mgmtResponsibilities = (data && data.governanceData?.managementResponsibilities) || 'Defined and operational';
    
    pdf.text('Board oversight of climate-related issues: ' + boardOversight + '', DESIGN.layout.margins.left + 5, y + 6);
    pdf.text('Frequency of board climate discussions: ' + boardFrequency + '', DESIGN.layout.margins.left + 5, y + 12);
    pdf.text('Management climate responsibilities: ' + mgmtResponsibilities + '', DESIGN.layout.margins.left + 5, y + 18);
    
    return y + 35;
  }

  /**
   * Add ESRS E1 transition plan section only
   */
  private addESRSE1TransitionPlan(pdf: jsPDF, y: number, data?: PDFExportData): number {
    const { colors, typography } = DESIGN;
    
    pdf.setFontSize(typography.sizes.h2);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    pdf.text('ESRS E1 - Climate Change', DESIGN.layout.margins.left, y);
    
    y += 10;
    
    const pageWidth = 210;
    const boxWidth = pageWidth - DESIGN.layout.margins.left - DESIGN.layout.margins.right;
    pdf.setFillColor(colors.lightGreen.r, colors.lightGreen.g, colors.lightGreen.b);
    pdf.rect(DESIGN.layout.margins.left, y - 5, boxWidth, 22, 'F');
    
    pdf.setFontSize(typography.sizes.body);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b);
    pdf.text('E1-1: Transition plan for climate change mitigation', DESIGN.layout.margins.left + 5, y);
    
    pdf.setFont(typography.fonts.primary, 'normal');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    
    // Use actual data if available
    const planAdopted = (data && data.transitionPlan?.adopted !== undefined) ? 
      (data.transitionPlan.adopted ? 'Yes' : 'No') : 'Yes';
    const aligned15C = (data && data.transitionPlan?.alignedWith15C !== undefined) ? 
      (data.transitionPlan.alignedWith15C ? 'Yes' : 'No') : 'Yes';
    
    pdf.text('Transition plan adopted: ' + planAdopted + '', DESIGN.layout.margins.left + 5, y + 6);
    pdf.text('Aligned with 1.5°C pathway: ' + aligned15C + '', DESIGN.layout.margins.left + 5, y + 12);
    
    return y + 28;
  }

  /**
   * Add ESRS E1 sections (wrapper for backward compatibility)
   */
  private addESRSE1Sections(pdf: jsPDF, data: PDFExportData, y: number): number {
    // Call the transition plan section
    y = this.addESRSE1TransitionPlan(pdf, y, data);
    
    // Add some spacing
    y += 15;
    
    // Call the targets section
    y = this.addESRSE1Targets(pdf, data, y);
    
    return y;
  }

  /**
   * Add ESRS E1 targets section
   */
  private addESRSE1Targets(pdf: jsPDF, data: PDFExportData, y: number): number {
    const { colors, typography } = DESIGN;
    
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b);
    pdf.text('E1-4: GHG emission reduction targets', DESIGN.layout.margins.left, y);
    
    y += 8;
    
    const targetData = [
      ['Absolute reduction', 'Scopes 1, 2 & 3', '2019', '2030', '50%', '25%', 'SBTi 1.5°C'],
      ['Intensity reduction', 'Scopes 1 & 2', '2019', '2025', '30%', '40%', 'Internal'],
      ['Net-zero target', 'All scopes', '2019', '2050', '90%', '10%', 'SBTi Net-Zero']
    ];
    
    (pdf as any).autoTable({
      startY: y,
      head: [['Target Type', 'Scope', 'Base Year', 'Target Year', 'Reduction', 'Progress', 'Validation']],
      body: targetData,
      theme: 'grid',
      headStyles: {
        fillColor: [colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b],
        textColor: 255,
        fontSize: typography.sizes.small,
        fontStyle: 'bold',
        cellPadding: 3
      },
      bodyStyles: {
        fontSize: typography.sizes.small,
        textColor: [colors.black.r, colors.black.g, colors.black.b],
        cellPadding: 3
      },
      columnStyles: {
        0: { cellWidth: 35 },
        1: { cellWidth: 28 },
        2: { cellWidth: 18 },
        3: { cellWidth: 20 },
        4: { cellWidth: 20 },
        5: { cellWidth: 20 },
        6: { cellWidth: 25 }
      },
      margin: { left: DESIGN.layout.margins.left, right: DESIGN.layout.margins.right }
    });
    
    return (pdf as any).lastAutoTable.finalY + 15;
  }

  /**
   * Add emissions summary visualization
   */
  private addEmissionsSummary(pdf: jsPDF, data: PDFExportData, scope3Data: Scope3Category[], y: number): number {
    const { colors, typography, layout } = DESIGN;
    
    // Section header
    pdf.setFontSize(typography.sizes.h2);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    pdf.text('Emissions Overview', layout.margins.left, y);
    
    y += layout.spacing.subsection;
    
    // Scope breakdown visualization (simple bar chart)
    // Uses summary data as source of truth
    const barHeight = 20;
    const barWidth = 150;
    const scopes = [
      { name: 'Scope 1', value: data.summary.scope1, percentage: data.summary.scope1Percentage },
      { name: 'Scope 2', value: data.summary.scope2, percentage: data.summary.scope2Percentage },
      { name: 'Scope 3', value: data.summary.scope3, percentage: data.summary.scope3Percentage }
    ];
    
    scopes.forEach((scope, index) => {
      const barY = y + (index * (barHeight + 5));
      
      // Label
      pdf.setFontSize(typography.sizes.body);
      pdf.setFont(typography.fonts.primary, 'normal');
      pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
      pdf.text(scope.name, layout.margins.left, barY + 4);
      
      // Background bar
      pdf.setFillColor(colors.lightGray.r, colors.lightGray.g, colors.lightGray.b);
      pdf.rect(layout.margins.left + 25, barY, barWidth, barHeight - 5, 'F');
      
      // Value bar
      const valueWidth = (scope.percentage / 100) * barWidth;
      pdf.setFillColor(colors.green.r, colors.green.g, colors.green.b);
      pdf.rect(layout.margins.left + 25, barY, valueWidth, barHeight - 5, 'F');
      
      // Value text
      pdf.setFontSize(typography.sizes.small);
      pdf.text(
        '' + scope.value.toFixed(1) + ' tCO2e (' + scope.percentage.toFixed(0) + '%)',
        layout.margins.left + 25 + barWidth + 5,
        barY + 4
      );
    });
    
    return y + (scopes.length * (barHeight + 5)) + layout.spacing.section;
  }

  /**
   * Enhanced detailed emissions table with fixed Scope 3 data
   * IMPORTANT: Uses summary data as source of truth, not recalculated values
   */
  private addDetailedEmissionsTable(pdf: jsPDF, data: PDFExportData, processedScope3: Scope3Category[], y: number): number {
    const { colors, typography } = DESIGN;
    
    // Section header
    pdf.setFontSize(typography.sizes.h2);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    pdf.text('E1-6: Gross Scopes 1, 2, 3 and Total GHG emissions', DESIGN.layout.margins.left, y);
    
    y += 10;
    
    // Prepare table data
    const tableData = [];
    
    // Scope 1 - with subcategories if available
    tableData.push(['Scope 1 - Direct emissions', '', '', '', '']);
    
    const scope1Categories = this.getScope1Breakdown(data);
    scope1Categories.forEach(cat => {
      if (cat.emissions > 0) {
        tableData.push([
          '   ' + cat.name + '',
          cat.emissions.toFixed(3),
          cat.dataQuality,
          cat.method,
          'E1-6.53'
        ]);
      }
    });
    
    // Use SUMMARY data for Scope 1 total
    tableData.push(['Scope 1 Total', data.summary.scope1.toFixed(3), 'High', 'Direct measurement', 'E1-6.53']);
    tableData.push(['', '', '', '', '']);
    
    // Scope 2
    tableData.push(['Scope 2 - Indirect emissions from purchased energy', '', '', '', '']);
    tableData.push(['   Location-based', data.summary.scope2.toFixed(3), 'High', 'Grid average factors', 'E1-6.54']);
    if (data.summary.scope2Market !== undefined && data.summary.scope2Market !== null) {
      tableData.push(['   Market-based', data.summary.scope2Market.toFixed(3), 'High', 'Supplier-specific factors', 'E1-6.54']);
    }
    tableData.push(['', '', '', '', '']);
    
    // Scope 3 - using processed data for categories but summary for total
    tableData.push(['Scope 3 - Other indirect emissions (GHG Protocol Categories)', '', '', '', '']);
    
    processedScope3.forEach(cat => {
      let value = cat.emissions > 0 ? cat.emissions.toFixed(3) : 'N/A';
      let quality = cat.emissions > 0 ? cat.dataQuality : '-';
      let method = cat.emissions > 0 ? cat.calculationMethod : cat.notApplicableReason || 'Not calculated';
      
      tableData.push([
        '   ' + cat.category + '',
        value,
        quality,
        method,
        'E1-6.55'
      ]);
    });
    
    tableData.push(['', '', '', '', '']);
    
    // Use SUMMARY data for Scope 3 total
    tableData.push(['Scope 3 Total', data.summary.scope3.toFixed(3), 'See categories', '', 'E1-6.55']);
    tableData.push(['', '', '', '', '']);
    
    // Use SUMMARY data for total emissions
    tableData.push(['Total GHG emissions', data.summary.totalEmissions.toFixed(3), 'Mixed', '', 'E1-6.56']);
    
    // Create table
    (pdf as any).autoTable({
      startY: y,
      head: [['GHG Emissions', 'Value (tCO2e)', 'Data Quality', 'Calculation Method', 'ESRS Ref']],
      body: tableData,
      theme: 'grid',
      headStyles: {
        fillColor: [colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b],
        textColor: 255,
        fontSize: typography.sizes.small,
        fontStyle: 'bold',
        cellPadding: 3
      },
      bodyStyles: {
        fontSize: typography.sizes.tiny,
        textColor: [colors.black.r, colors.black.g, colors.black.b],
        cellPadding: 2
      },
      alternateRowStyles: {
        fillColor: [250, 250, 250]
      },
      columnStyles: {
        0: { cellWidth: 70 },
        1: { cellWidth: 25, halign: 'right' },
        2: { cellWidth: 20, halign: 'center' },
        3: { cellWidth: 35 },
        4: { cellWidth: 17, halign: 'center' }
      },
      margin: { left: DESIGN.layout.margins.left, right: DESIGN.layout.margins.right },
      pageBreak: 'auto',
      showHead: 'everyPage',
      didParseCell: (data: any) => {
        // Style the total row
        if (data.row.index === tableData.length - 1 && data.section === 'body') {
          data.cell.styles.fillColor = [colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b];
          data.cell.styles.textColor = [255, 255, 255];
          data.cell.styles.fontStyle = 'bold';
        }
        // Style section headers
        if (data.cell.text[0] && data.cell.text[0].startsWith('Scope') && !data.cell.text[0].includes('   ')) {
          data.cell.styles.fontStyle = 'bold';
          data.cell.styles.fillColor = [colors.lightGreen.r, colors.lightGreen.g, colors.lightGreen.b];
        }
      }
    });
    
    return (pdf as any).lastAutoTable.finalY + 15;
  }

  /**
   * Get Scope 1 breakdown from activities
   * Ensures subcategories don't exceed summary total
   */
  private getScope1Breakdown(data: PDFExportData): Array<{name: string, emissions: number, dataQuality: string, method: string}> {
    const categories = [
      { name: 'Stationary Combustion', emissions: 0, dataQuality: 'High', method: 'Direct measurement' },
      { name: 'Mobile Combustion', emissions: 0, dataQuality: 'High', method: 'Direct measurement' },
      { name: 'Process Emissions', emissions: 0, dataQuality: 'High', method: 'Direct measurement' },
      { name: 'Fugitive Emissions', emissions: 0, dataQuality: 'High', method: 'Direct measurement' }
    ];
    
    if (data.activities) {
      data.activities.forEach(activity => {
        const category = categories.find(cat => cat.name === activity.categoryName);
        if (category) {
          const amount = this.parseNumber(activity.amount);
          const factor = this.parseNumber(activity.factor);
          
          // Check if emissions are pre-calculated
          let emissions = 0;
          if (activity.emissions !== undefined) {
            emissions = this.parseNumber(activity.emissions);
          } else {
            emissions = (amount * factor) / 1000;
          }
          
          category.emissions += emissions;
        }
      });
    }
    
    // Ensure subcategories don't exceed total
    const calculatedScope1 = categories.reduce((sum, cat) => sum + cat.emissions, 0);
    const summaryScope1 = data.summary.scope1;
    
    // If calculated exceeds summary, scale down proportionally
    if (calculatedScope1 > summaryScope1 && calculatedScope1 > 0) {
      const scaleFactor = summaryScope1 / calculatedScope1;
      categories.forEach(cat => {
        cat.emissions = cat.emissions * scaleFactor;
      });
    }
    
    return categories;
  }

  /**
   * Enhanced Scope 3 categories table
   */
  private addScope3Categories(pdf: jsPDF, scope3Data: Scope3Category[], y: number, summaryScope3Total?: number): number {
    const { colors, typography } = DESIGN;
    
    pdf.setFontSize(typography.sizes.h2);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    pdf.text('Scope 3 Categories - Detailed Analysis', DESIGN.layout.margins.left, y);
    
    y += 10;
    
    // Use summary total if provided, otherwise calculate from categories
    const totalScope3 = summaryScope3Total !== undefined ? summaryScope3Total :
      scope3Data.reduce((sum, cat) => sum + cat.emissions, 0);
    
    // Build table data
    const tableData = scope3Data.map(cat => {
      // Use simple text instead of Unicode symbols for better PDF compatibility
      let status = '';
      if (cat.emissions > 0) {
        status = 'Yes';
      } else if (cat.applicabilityStatus === 'not-applicable') {
        status = 'N/A';
      } else if (cat.applicabilityStatus === 'de-minimis') {
        status = '<1%';
      } else {
        status = 'No';
      }
      
      // Recalculate percentage based on the correct total
      const percentage = totalScope3 > 0 ? (cat.emissions / totalScope3) * 100 : 0;
      
      return [
        cat.category,
        cat.emissions > 0 ? cat.emissions.toFixed(3) : '-',
        cat.emissions > 0 ? '' + percentage.toFixed(1) + '%' : '-',
        cat.activities.toString(),
        cat.hasEvidence ? 'Yes' : 'No',
        status
      ];
    });
    
    (pdf as any).autoTable({
      startY: y,
      head: [['Category', 'tCO2e', '% Scope 3', 'Count', 'Docs', 'Status']],
      body: tableData,
      theme: 'grid',
      headStyles: {
        fillColor: [colors.green.r, colors.green.g, colors.green.b],
        textColor: 255,
        fontSize: typography.sizes.tiny,  // Smaller font for headers
        fontStyle: 'bold',
        cellPadding: 2.5  // Slightly less padding
      },
      bodyStyles: {
        fontSize: typography.sizes.small,
        cellPadding: 3
      },
      columnStyles: {
        0: { cellWidth: 62 },
        1: { cellWidth: 22, halign: 'right' },
        2: { cellWidth: 20, halign: 'right' },
        3: { cellWidth: 16, halign: 'center' },
        4: { cellWidth: 16, halign: 'center' },
        5: { cellWidth: 18, halign: 'center' }
      },
      margin: { left: DESIGN.layout.margins.left, right: DESIGN.layout.margins.right + 5 },  // Extra margin
      pageBreak: 'auto',
      showHead: 'everyPage',
      didParseCell: (data: any) => {
        // Color code status column
        if (data.column.index === 5 && data.section === 'body') {
          const status = data.cell.text[0];
          if (status === 'Yes') {
            data.cell.styles.textColor = [colors.success.r, colors.success.g, colors.success.b];
            data.cell.styles.fontStyle = 'bold';
          } else if (status === 'N/A') {
            data.cell.styles.textColor = [colors.gray.r, colors.gray.g, colors.gray.b];
            data.cell.styles.fontStyle = 'italic';
          } else if (status === '<1%') {
            data.cell.styles.textColor = [colors.gray.r, colors.gray.g, colors.gray.b];
            data.cell.styles.fontSize = typography.sizes.tiny;
          } else if (status === 'No') {
            data.cell.styles.textColor = [colors.warning.r, colors.warning.g, colors.warning.b];
          }
        }
      }
    });
    
    y = (pdf as any).lastAutoTable.finalY + 10;
    
    // Summary box
    pdf.setFillColor(colors.lightGreen.r, colors.lightGreen.g, colors.lightGreen.b);
    pdf.rect(DESIGN.layout.margins.left, y, 170, 12, 'F');
    
    pdf.setTextColor(colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b);
    pdf.setFontSize(typography.sizes.body);
    pdf.setFont(typography.fonts.primary, 'bold');
    
    const applicableCount = scope3Data.filter(cat => cat.applicabilityStatus === 'applicable').length;
    const calculatedCount = scope3Data.filter(cat => cat.emissions > 0).length;
    
    pdf.text('Total Scope 3: ' + totalScope3.toFixed(3) + ' tCO2e', DESIGN.layout.margins.left + 5, y + 5);
    pdf.text('Categories: ' + calculatedCount + '/' + applicableCount + ' calculated', DESIGN.layout.margins.left + 5, y + 9);
    
    // Add legend
    y += 20;
    pdf.setFontSize(typography.sizes.tiny);
    pdf.setFont(typography.fonts.primary, 'italic');
    pdf.setTextColor(colors.gray.r, colors.gray.g, colors.gray.b);
    pdf.text('Status: Yes = Calculated | No = Not calculated | N/A = Not applicable | <1% = De minimis', 
      DESIGN.layout.margins.left, y);
    
    return y + 10;
  }

  /**
   * Add activity details with improved formatting
   */
  private addActivityDetails(pdf: jsPDF, data: PDFExportData, y: number): number {
    const { colors, typography } = DESIGN;
    
    pdf.setFontSize(typography.sizes.h2);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    pdf.text('Activity-level Emissions Data', DESIGN.layout.margins.left, y);
    
    y += 10;
    
    if (data.activities && data.activities.length > 0) {
      // Process and sort activities
      const processedActivities = data.activities
        .filter(a => this.parseNumber(a.amount) > 0)
        .map(activity => {
          const amount = this.parseNumber(activity.amount);
          const factor = this.parseNumber(activity.factor);
          
          // Use pre-calculated emissions if available
          let emissions = 0;
          if (activity.emissions !== undefined && activity.emissions !== null) {
            emissions = this.parseNumber(activity.emissions);
          } else {
            // Calculate emissions using standard formula
            emissions = (amount * factor) / 1000;
          }
          
          return {
            ...activity,
            calculatedEmissions: emissions,
            scope: this.determineScope(activity.categoryName)
          };
        })
        .sort((a, b) => b.calculatedEmissions - a.calculatedEmissions);
      
      // Group by scope
      const scopeGroups = {
        scope1: processedActivities.filter(a => a.scope === 'scope1'),
        scope2: processedActivities.filter(a => a.scope === 'scope2'),
        scope3: processedActivities.filter(a => a.scope === 'scope3')
      };
      
      // Prepare table data
      const tableData: any[] = [];
      
      ['scope1', 'scope2', 'scope3'].forEach(scope => {
        const activities = scopeGroups[scope as keyof typeof scopeGroups];
        if (activities.length > 0) {
          // Add scope header
          const scopeName = scope.charAt(0).toUpperCase() + scope.slice(1).replace(/(\d)/, ' $1');
          tableData.push([scopeName, '', '', '', '', '']);
          
          // Add top activities for this scope
          activities.slice(0, 20).forEach(activity => {
            tableData.push([
              activity.name || 'Unnamed activity',
              activity.categoryName || '',
              '' + this.parseNumber(activity.amount).toLocaleString() + '',
              activity.unit || '',
              activity.factor ? this.parseNumber(activity.factor).toFixed(3) : '',
              activity.calculatedEmissions.toFixed(3)
            ]);
          });
        }
      });
      
      (pdf as any).autoTable({
        startY: y,
        head: [['Activity', 'Category', 'Qty', 'Unit', 'Factor', 'tCO2e']],
        body: tableData,
        theme: 'grid',
        headStyles: {
          fillColor: [colors.green.r, colors.green.g, colors.green.b],
          textColor: 255,
          fontSize: typography.sizes.tiny,  // Smaller font to prevent wrapping
          fontStyle: 'bold',
          cellPadding: 2.5  // Reduced padding
        },
        bodyStyles: {
          fontSize: typography.sizes.tiny,
          cellPadding: 2
        },
        columnStyles: {
          0: { cellWidth: 48 },
          1: { cellWidth: 44 },
          2: { cellWidth: 22, halign: 'right' },
          3: { cellWidth: 14 },
          4: { cellWidth: 18, halign: 'right' },
          5: { cellWidth: 18, halign: 'right' }
        },
        margin: { left: DESIGN.layout.margins.left, right: DESIGN.layout.margins.right + 5 },  // Extra margin to prevent edge issues
        pageBreak: 'auto',
        showHead: 'everyPage',
        didParseCell: (data: any) => {
          // Style scope headers
          if (data.cell.text[0] && data.cell.text[0].startsWith('Scope') && data.column.index === 0) {
            data.cell.styles.fontStyle = 'bold';
            data.cell.styles.fillColor = [colors.lightGreen.r, colors.lightGreen.g, colors.lightGreen.b];
            data.cell.colSpan = 6;
          }
        }
      });
      
      y = (pdf as any).lastAutoTable.finalY + 5;
      
      // Add summary note
      pdf.setFontSize(typography.sizes.tiny);
      pdf.setFont(typography.fonts.primary, 'italic');
      pdf.setTextColor(colors.gray.r, colors.gray.g, colors.gray.b);
      const totalActivities = processedActivities.length;
      const shownActivities = Math.min(totalActivities, 60);
      pdf.text(
        'Note: Showing top ' + shownActivities + ' of ' + totalActivities + ' activities, sorted by emissions impact.',
        DESIGN.layout.margins.left,
        y
      );
    }
    
    return y + 10;
  }

  /**
   * Determine scope from category name
   */
  private determineScope(categoryName: string): string {
    if (!categoryName) return 'unknown';
    
    const scope1Categories = ['Stationary Combustion', 'Mobile Combustion', 'Process Emissions', 'Fugitive Emissions'];
    const scope2Categories = ['Purchased Electricity', 'Purchased Heat', 'Purchased Steam', 'Purchased Cooling', 
                             'Grid Electricity', 'District Heating', 'District Cooling'];
    
    if (scope1Categories.includes(categoryName)) return 'scope1';
    if (scope2Categories.some(cat => categoryName.includes(cat))) return 'scope2';
    if (categoryName.match(/^\d+\./)) return 'scope3';
    
    return 'unknown';
  }

  /**
   * Professional footer
   */
  private addFooters(pdf: jsPDF, data: PDFExportData): void {
    const pageCount = (pdf as any).getNumberOfPages();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const pageWidth = pdf.internal.pageSize.getWidth();
    
    for (let i = 1; i <= pageCount; i++) {
      pdf.setPage(i);
      
      // Footer line
      pdf.setDrawColor(DESIGN.colors.lightGray.r, DESIGN.colors.lightGray.g, DESIGN.colors.lightGray.b);
      pdf.setLineWidth(0.5);
      pdf.line(DESIGN.layout.margins.left, pageHeight - 15, pageWidth - DESIGN.layout.margins.right, pageHeight - 15);
      
      // Page number
      pdf.setFontSize(DESIGN.typography.sizes.small);
      pdf.setTextColor(DESIGN.colors.gray.r, DESIGN.colors.gray.g, DESIGN.colors.gray.b);
    pdf.text('Page ' + i + ' of ' + pageCount + '', pageWidth / 2, pageHeight - 20, { align: 'center' });
      
      // Footer text
      pdf.setFontSize(DESIGN.typography.sizes.tiny);
      const footerText = '' + (data.metadata.companyName || 'Your Company') + ' | ESRS E1 Climate Disclosures | ' + data.metadata.reportingPeriod + '';
      pdf.text(footerText, DESIGN.layout.margins.left, pageHeight - 10);
      
      // Version/Document ID
      const versionText = data.metadata.version || 'v' + this.version + '';
      pdf.text(versionText, pageWidth - DESIGN.layout.margins.right, pageHeight - 10, { align: 'right' });
    }
    return currentY;
  }
    return currentY;
  }
  }

  // Utility methods
  private createBatches<T>(items: T[], batchSize: number): T[][] {
    const batches: T[][] = [];
    for (let i = 0; i < items.length; i += batchSize) {
      batches.push(items.slice(i, i + batchSize));
    }
    return batches;
  }

  private delay(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  private downloadBlob(blob: Blob, filename: string): void {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
}

// Export convenience functions
export async function generatePDFReport(
  data: PDFExportData,
  options?: { useBackend?: boolean; filename?: string; compress?: boolean; validate?: boolean }
): Promise<ExportResult> {
  const handler = PDFExportHandler.getInstance();
  return handler.exportSinglePDF(data, options);
}

export function usePDFExport() {
  const [exporting, setExporting] = useState(false);
  const [progress, setProgress] = useState(0);
  const [currentDoc, setCurrentDoc] = useState('');
  const [results, setResults] = useState<ExportResult[]>([]);

  const exportSingle = async (data: PDFExportData, options?: any) => {
    setExporting(true);
    setProgress(0);
    
    try {
      const result = await generatePDFReport(data, options);
      setProgress(100);
      return result;
    } finally {
      setExporting(false);
    }
  };

  const exportBulk = async (documents: PDFExportData[], options?: any) => {
    setExporting(true);
    setProgress(0);
    setResults([]);

    const handler = PDFExportHandler.getInstance();
    try {
      const results = await handler.exportBulkPDFs({
        documents,
        ...options,
        onProgress: (prog, doc) => {
          setProgress(prog);
          setCurrentDoc(doc);
        },
        onComplete: (res) => {
          setResults(res);
        }
      });
      return results;
    } finally {
      setExporting(false);
    }
  };

  return {
    exportSingle,
    exportBulk,
    exporting,
    progress,
    currentDoc,
    results
  };
}

// Export types
export type { PDFExportData, ExportResult, EmissionActivity, Scope3Category, BulkExportOptions };

// Production-ready usage example:
/*
const pdfData: PDFExportData = {
  metadata: {
    companyName: "Your Company",
    reportingPeriod: "2025-07",
    generatedDate: new Date().toISOString(),
    documentId: "GHG-" + Math.random().toString(36).substr(2, 9),
    standard: "ESRS E1 Compliant"
  },
  summary: {
    totalEmissions: 100.5,      // Must equal scope1 + scope2 + scope3
    scope1: 10.5,              // Direct emissions
    scope2: 20.0,              // Indirect from energy
    scope3: 70.0,              // Other indirect
    scope1Percentage: 10.4,    // Will be recalculated
    scope2Percentage: 19.9,    // Will be recalculated  
    scope3Percentage: 69.7,    // Will be recalculated
    dataQualityScore: 85,
    evidenceCount: 12
  },
  activities: [
    {
      name: "Natural Gas Heating",
      categoryName: "Stationary Combustion",
      amount: 1000,
      unit: "kWh",
      factor: 0.185,
      emissions: 0.185  // Optional: pre-calculated
    }
  ],
  scope3Analysis: [
    {
      category: "1. Purchased goods and services",
      categoryNumber: 1,
      emissions: 25.5,
      activities: 15,
    
    return currentY;
  }
      percentage: 36.4,
      dataQuality: "Medium",
      calculationMethod: "Spend-based"
    }
  ]
};

// Generate PDF
const result = await generatePDFReport(pdfData, {
  filename: "emissions_report_2025.pdf",
  compress: true,
  validate: true
});
*/
