/**
 * Professional PDF Export Handler - Enterprise Production Edition
 * ==============================================================
 * 
 * A production-ready PDF generation system for GHG emissions reporting
 * following ESRS E1 compliance standards with robust data validation.
 * 
 * DATA CONSISTENCY PRINCIPLES:
 * 1. Summary data (scope1, scope2, scope3, totalEmissions) is the SOURCE OF TRUTH
 * 2. Activities are used for detailed breakdowns only, not for recalculation
 * 3. All totals throughout the PDF match the summary data
 * 4. Percentages are recalculated to ensure they sum to 100%
 * 
 * EMISSIONS CALCULATION:
 * The PDF handler assumes emissions = (amount * factor) / 1000
 * If your main app uses a different formula, update the calculation in:
 * - processScope3Data() method
 * - getScope1Breakdown() method
 * - addActivityDetails() method
 * 
 * GOVERNANCE DATA:
 * Board oversight, transition plans, and targets shown in the PDF are placeholders.
 * In production, pass actual data via governanceData and transitionPlan objects.
 * 
 * @author Dr. Samantha Voronova-Patel
 * @version 3.1.0
 * @license MIT
 */

import jsPDF from 'jspdf';
import 'jspdf-autotable';
import html2canvas from 'html2canvas';
import { useState } from 'react';

// Extend jsPDF type for autoTable
declare module 'jspdf' {
  interface jsPDF {
    autoTable: (options: any) => jsPDF;
    lastAutoTable: { finalY: number };
  }
}

// Enhanced type definitions with validation
interface EmissionActivity {
  id?: string;
  name: string;
  categoryName: string;
  scopeCategory?: string; // "scope1", "scope2", "scope3"
  amount: number | string;
  unit: string;
  factor: number | string;
  emissions?: number | string;
  evidence?: Array<{
    id: string;
    filename: string;
    type: string;
  }>;
  dataQuality?: 'high' | 'medium' | 'low';
  calculationMethod?: string;
}

interface Scope3Category {
  category: string;
  categoryNumber: number;
  emissions: number;
  activities: number;
  hasEvidence: boolean;
  percentage: number;
  dataQuality: string;
  calculationMethod: string;
  applicabilityStatus?: 'applicable' | 'not-applicable' | 'de-minimis';
  notApplicableReason?: string;
}

interface PDFExportData {
  metadata: {
    reportTitle: string;
    companyName: string;
    reportingPeriod: string;
    generatedDate: string;
    documentId: string;
    standard?: string;
    methodology?: string;
    preparedBy?: string;
    reviewedBy?: string;
    version?: string;
  };
  summary: {
    totalEmissions: number;
    scope1: number;
    scope2: number;
    scope2Market?: number;
    scope3: number;
    scope1Percentage: number;
    scope2Percentage: number;
    scope3Percentage: number;
    dataQualityScore: number;
    evidenceCount: number;
    calculationCompleteness?: number;
  };
  topEmissionSources: Array<{
    name: string;
    category: string;
    emissions: number;
    percentage: number;
  }>;
  scope3Analysis?: Scope3Category[];
  activities?: EmissionActivity[];
  evidenceFiles?: any[];
  uncertaintyAnalysis?: any;
  dataQuality?: any;
  chartElements?: HTMLElement[];
  companyProfile?: {
    sector: string;
    employees: number;
    revenue?: number;
    operations?: string[];
  };
  governanceData?: {
    boardOversight?: string;
    boardMeetingFrequency?: string;
    managementResponsibilities?: string;
  };
  transitionPlan?: {
    adopted?: boolean;
    alignedWith15C?: boolean;
    details?: string;
  };
}

interface BulkExportOptions {
  documents: PDFExportData[];
  onProgress?: (progress: number, currentDoc: string) => void;
  onComplete?: (results: ExportResult[]) => void;
  parallelLimit?: number;
  retryAttempts?: number;
  compressionLevel?: 'none' | 'fast' | 'best';
  apiUrl?: string;
}

interface ExportResult {
  success: boolean;
  documentId: string;
  filename: string;
  size?: number;
  error?: string;
  timestamp?: string;
}

// Professional Design System
const DESIGN = {
  colors: {
    // Primary palette
    darkGreen: { r: 46, g: 125, b: 50 },     // #2E7D32
    green: { r: 76, g: 175, b: 80 },         // #4CAF50
    lightGreen: { r: 232, g: 245, b: 233 },  // #E8F5E9
    
    // Text hierarchy
    black: { r: 0, g: 0, b: 0 },             // #000000
    darkGray: { r: 66, g: 66, b: 66 },       // #424242
    gray: { r: 117, g: 117, b: 117 },        // #757575
    lightGray: { r: 224, g: 224, b: 224 },   // #E0E0E0
    
    // Background
    white: { r: 255, g: 255, b: 255 },       // #FFFFFF
    offWhite: { r: 250, g: 250, b: 250 },    // #FAFAFA
    
    // Status colors
    error: { r: 211, g: 47, b: 47 },         // #D32F2F
    warning: { r: 245, g: 124, b: 0 },       // #F57C00
    success: { r: 56, g: 142, b: 60 }        // #388E3C
  },
  typography: {
    fonts: {
      primary: 'helvetica',
      mono: 'courier'
    },
    sizes: {
      h1: 16,
      h2: 14,
      h3: 12,
      body: 10,
      small: 9,
      tiny: 8,
      micro: 7
    }
  },
  layout: {
    margins: {
      top: 25,
      right: 15,
      bottom: 20,
      left: 15
    },
    spacing: {
      section: 15,
      subsection: 10,
      paragraph: 8,
      line: 6
    }
  }
};

// Scope 3 Category Definitions
const SCOPE3_CATEGORIES = [
  { num: 1, name: 'Purchased goods and services', defaultMethod: 'Spend-based' },
  { num: 2, name: 'Capital goods', defaultMethod: 'Average-data' },
  { num: 3, name: 'Fuel- and energy-related activities', defaultMethod: 'Average-data' },
  { num: 4, name: 'Upstream transportation and distribution', defaultMethod: 'Distance-based' },
  { num: 5, name: 'Waste generated in operations', defaultMethod: 'Waste-type-specific' },
  { num: 6, name: 'Business travel', defaultMethod: 'Distance-based' },
  { num: 7, name: 'Employee commuting', defaultMethod: 'Distance-based' },
  { num: 8, name: 'Upstream leased assets', defaultMethod: 'Asset-specific' },
  { num: 9, name: 'Downstream transportation and distribution', defaultMethod: 'Distance-based' },
  { num: 10, name: 'Processing of sold products', defaultMethod: 'Average-data' },
  { num: 11, name: 'Use of sold products', defaultMethod: 'Direct use-phase' },
  { num: 12, name: 'End-of-life treatment of sold products', defaultMethod: 'Waste-type-specific' },
  { num: 13, name: 'Downstream leased assets', defaultMethod: 'Asset-specific' },
  { num: 14, name: 'Franchises', defaultMethod: 'Franchise-specific' },
  { num: 15, name: 'Investments', defaultMethod: 'Investment-specific' }
];

/**
 * Main PDF Export Handler Class
 * @version 3.1.0 - Production Ready with Data Consistency
 */
export class PDFExportHandler {
  private static instance: PDFExportHandler;
  private apiUrl: string;
  private validationErrors: string[] = [];
  private readonly version = '3.1.0';

  private constructor(apiUrl: string = 'http://localhost:8000') {
    this.apiUrl = apiUrl;
  }

  static getInstance(apiUrl?: string): PDFExportHandler {
    if (!PDFExportHandler.instance) {
      PDFExportHandler.instance = new PDFExportHandler(apiUrl);
    }
    return PDFExportHandler.instance;
  }

  /**
   * Validate export data before processing
   */
  private validateData(data: PDFExportData): boolean {
    this.validationErrors = [];

    if (!data.metadata?.companyName) {
      this.validationErrors.push('Company name is required');
    }
    if (!data.metadata?.reportingPeriod) {
      this.validationErrors.push('Reporting period is required');
    }
    if (typeof data.summary?.totalEmissions !== 'number' || data.summary.totalEmissions < 0) {
      this.validationErrors.push('Invalid total emissions value');
    }

    // Validate scope totals
    const calculatedTotal = (data.summary?.scope1 || 0) + 
                           (data.summary?.scope2 || 0) + 
                           (data.summary?.scope3 || 0);
    
    // Allow small rounding differences (0.01 tCO2e)
    if (Math.abs(calculatedTotal - (data.summary?.totalEmissions || 0)) > 0.01) {
      this.validationErrors.push(
        `Scope totals (${calculatedTotal.toFixed(3)}) do not match total emissions (${data.summary?.totalEmissions?.toFixed(3)})`
      );
    }

    // Validate percentages
    const totalPercentage = (data.summary?.scope1Percentage || 0) +
                           (data.summary?.scope2Percentage || 0) +
                           (data.summary?.scope3Percentage || 0);
    
    if (Math.abs(totalPercentage - 100) > 1) {
      this.validationErrors.push(`Scope percentages do not sum to 100% (${totalPercentage.toFixed(1)}%)`);
    }

    return this.validationErrors.length === 0;
  }

  /**
   * Reconcile data to ensure consistency
   * This ensures summary data is the source of truth
   */
  private reconcileData(data: PDFExportData): PDFExportData {
    // Ensure percentages are correct
    const total = data.summary.totalEmissions;
    if (total > 0) {
      data.summary.scope1Percentage = (data.summary.scope1 / total) * 100;
      data.summary.scope2Percentage = (data.summary.scope2 / total) * 100;
      data.summary.scope3Percentage = (data.summary.scope3 / total) * 100;
    }

    // Ensure total matches sum of scopes
    const calculatedTotal = data.summary.scope1 + data.summary.scope2 + data.summary.scope3;
    if (Math.abs(calculatedTotal - total) > 0.01) {
      console.warn('Total emissions mismatch detected, using sum of scopes');
      data.summary.totalEmissions = calculatedTotal;
    }

    return data;
  }

  /**
   * Process and normalize Scope 3 data from activities
   * IMPORTANT: This method organizes activities by category but does NOT recalculate totals
   * It uses the summary data as the source of truth
   */
  private processScope3Data(data: PDFExportData): Scope3Category[] {
    const scope3Map = new Map<number, Scope3Category>();

    // Initialize all categories
    SCOPE3_CATEGORIES.forEach(cat => {
      scope3Map.set(cat.num, {
        category: `${cat.num}. ${cat.name}`,
        categoryNumber: cat.num,
        emissions: 0,
        activities: 0,
        hasEvidence: false,
        percentage: 0,
        dataQuality: 'Low',
        calculationMethod: cat.defaultMethod,
        applicabilityStatus: 'applicable'
      });
    });

    // First, use scope3Analysis if provided (this is the authoritative source)
    if (data.scope3Analysis && data.scope3Analysis.length > 0) {
      data.scope3Analysis.forEach(analysis => {
        const match = analysis.category.match(/^(\d+)\./);
        if (match) {
          const catNum = parseInt(match[1]);
          const category = scope3Map.get(catNum);
          if (category) {
            category.emissions = analysis.emissions;
            category.activities = analysis.activities;
            category.hasEvidence = analysis.hasEvidence;
            category.percentage = analysis.percentage;
            if (analysis.dataQuality) category.dataQuality = analysis.dataQuality;
            if (analysis.calculationMethod) category.calculationMethod = analysis.calculationMethod;
          }
        }
      });
    } else if (data.activities) {
      // If no scope3Analysis, process activities but keep totals consistent with summary
      const activityByCategory = new Map<number, { count: number; hasEvidence: boolean; emissions: number }>();
      
      data.activities.forEach(activity => {
        const match = activity.categoryName?.match(/^(\d+)\./);
        if (match) {
          const catNum = parseInt(match[1]);
          if (catNum >= 1 && catNum <= 15) {
            if (!activityByCategory.has(catNum)) {
              activityByCategory.set(catNum, { count: 0, hasEvidence: false, emissions: 0 });
            }
            
            const catData = activityByCategory.get(catNum)!;
            catData.count++;
            
            // Calculate emissions for this activity
            const amount = this.parseNumber(activity.amount);
            const factor = this.parseNumber(activity.factor);
            
            // Check if emissions are pre-calculated
            let emissions = 0;
            if (activity.emissions !== undefined) {
              emissions = this.parseNumber(activity.emissions);
            } else {
              // IMPORTANT: This calculation must match your main app's formula
              // Default assumes: emissions (tCO2e) = amount * factor / 1000
              // If your app uses different units or formulas, update here
              emissions = (amount * factor) / 1000;
            }
            
            catData.emissions += emissions;
            
            if (activity.evidence && activity.evidence.length > 0) {
              catData.hasEvidence = true;
            }
          }
        }
      });
      
      // Apply the calculated data to categories
      activityByCategory.forEach((catData, catNum) => {
        const category = scope3Map.get(catNum);
        if (category) {
          category.emissions = catData.emissions;
          category.activities = catData.count;
          category.hasEvidence = catData.hasEvidence;
          
          // Update data quality based on evidence
          if (catData.hasEvidence) {
            category.dataQuality = 'Medium';
          }
        }
      });
    }

    // Calculate percentages based on the SUMMARY total, not recalculated total
    const totalScope3FromSummary = data.summary.scope3;

    scope3Map.forEach(category => {
      // Calculate percentage based on summary total
      category.percentage = totalScope3FromSummary > 0 ? 
        (category.emissions / totalScope3FromSummary) * 100 : 0;

      // Determine applicability based on company profile
      if (category.emissions === 0) {
        // Set not applicable reasons based on category
        switch (category.categoryNumber) {
          case 8:
            category.applicabilityStatus = 'not-applicable';
            category.notApplicableReason = 'No upstream leased assets';
            break;
          case 9:
            if (data.companyProfile?.sector === 'Services') {
              category.applicabilityStatus = 'not-applicable';
              category.notApplicableReason = 'B2B services only';
            }
            break;
          case 10:
          case 11:
          case 12:
            if (data.companyProfile?.sector === 'Services') {
              category.applicabilityStatus = 'not-applicable';
              category.notApplicableReason = 'Services company - no physical products';
            }
            break;
          case 13:
            category.applicabilityStatus = 'not-applicable';
            category.notApplicableReason = 'No downstream leased assets';
            break;
          case 14:
            category.applicabilityStatus = 'not-applicable';
            category.notApplicableReason = 'No franchise operations';
            break;
          case 15:
            if (category.percentage < 1 && totalScope3FromSummary > 0) {
              category.applicabilityStatus = 'de-minimis';
              category.notApplicableReason = 'De minimis (<1% of total)';
            }
            break;
          default:
            // For any other zero-emission categories
            category.notApplicableReason = 'Not calculated';
            break;
        }
      }
    });

    return Array.from(scope3Map.values());
  }

  /**
   * Parse number from various input types
   */
  private parseNumber(value: any): number {
    if (typeof value === 'number') return value;
    if (typeof value === 'string') {
      const parsed = parseFloat(value.replace(/,/g, ''));
      return isNaN(parsed) ? 0 : parsed;
    }
    return 0;
  }

  /**
   * Export single PDF with validation
   */
  async exportSinglePDF(
    data: PDFExportData,
    options: {
      useBackend?: boolean;
      filename?: string;
      compress?: boolean;
      validate?: boolean;
    } = {}
  ): Promise<ExportResult> {
    const {
      useBackend = false,
      filename = `${data.metadata.companyName}_ESRS_E1_Climate_Disclosures_${data.metadata.reportingPeriod}.pdf`,
      compress = true,
      validate = true
    } = options;

    try {
      // Validate data if requested
      if (validate && !this.validateData(data)) {
        throw new Error(`Validation failed: ${this.validationErrors.join(', ')}`);
      }

      // Log data structure in development for debugging
      if ((typeof process !== 'undefined' && process.env?.NODE_ENV === 'development') || 
          (typeof window !== 'undefined' && window.location?.hostname === 'localhost')) {
        console.log('PDF Export Data Summary:', {
          totalEmissions: data.summary.totalEmissions,
          scope1: data.summary.scope1,
          scope2: data.summary.scope2,
          scope3: data.summary.scope3,
          calculatedTotal: data.summary.scope1 + data.summary.scope2 + data.summary.scope3,
          activityCount: data.activities?.length || 0,
          scope3Categories: data.scope3Analysis?.length || 0
        });
      }

      const blob = await this.generatePDFClient(data, compress);
      this.downloadBlob(blob, filename);

      return {
        success: true,
        documentId: data.metadata.documentId,
        filename,
        size: blob.size,
        timestamp: new Date().toISOString()
      };
    } catch (error) {
      console.error('PDF export failed:', error);
      return {
        success: false,
        documentId: data.metadata.documentId,
        filename,
        error: error instanceof Error ? error.message : 'Unknown error',
        timestamp: new Date().toISOString()
      };
    }
  }

  /**
   * Bulk export multiple PDFs
   */
  async exportBulkPDFs(options: BulkExportOptions): Promise<ExportResult[]> {
    const {
      documents,
      onProgress,
      onComplete,
      parallelLimit = 3,
      retryAttempts = 2,
      compressionLevel = 'fast'
    } = options;

    const results: ExportResult[] = [];
    const totalDocs = documents.length;
    let completed = 0;

    // Process documents in batches
    const batches = this.createBatches(documents, parallelLimit);
    
    for (const batch of batches) {
      const batchPromises = batch.map(async (doc) => {
        let lastError: Error | null = null;
        
        for (let attempt = 0; attempt <= retryAttempts; attempt++) {
          try {
            const result = await this.exportSinglePDF(doc, {
              compress: compressionLevel !== 'none',
              filename: `${doc.metadata.companyName}_ESRS_E1_${doc.metadata.documentId}.pdf`
            });

            completed++;
            if (onProgress) {
              onProgress(
                (completed / totalDocs) * 100,
                `${doc.metadata.companyName} - ${doc.metadata.reportingPeriod}`
              );
            }

            return result;
          } catch (error) {
            lastError = error as Error;
            if (attempt < retryAttempts) {
              await this.delay(Math.pow(2, attempt) * 1000);
            }
          }
        }

        return {
          success: false,
          documentId: doc.metadata.documentId,
          filename: `${doc.metadata.companyName}_ESRS_E1_${doc.metadata.documentId}.pdf`,
          error: lastError?.message || 'Export failed after retries'
        };
      });

      const batchResults = await Promise.all(batchPromises);
      results.push(...batchResults);
    }

    if (onComplete) {
      onComplete(results);
    }

    return results;
  }

  /**
   * Generate production-ready PDF
   */
  private async generatePDFClient(data: PDFExportData, compress: boolean): Promise<Blob> {
    // Reconcile data to ensure consistency
    const reconciledData = this.reconcileData(data);
    
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4',
      compress
    });

    // Process Scope 3 data once for consistency
    const processedScope3 = this.processScope3Data(reconciledData);

    // Set document properties
    pdf.setProperties({
      title: `${reconciledData.metadata.companyName} - ESRS E1 Climate-related Disclosures`,
      subject: `Climate-related Disclosures - ${reconciledData.metadata.reportingPeriod}`,
      author: reconciledData.metadata.companyName,
      keywords: 'ESRS E1, GHG, emissions, climate, sustainability, carbon accounting',
      creator: 'FactorTrace GHG Calculator v3.0'
    });

    let currentY = DESIGN.layout.margins.top;

    // PAGE 1: Cover and Executive Summary
    this.addHeader(pdf, reconciledData);
    currentY = this.addTitle(pdf, reconciledData, currentY);
    currentY = this.addReportInfo(pdf, reconciledData, currentY);
    currentY = this.addExecutiveSummary(pdf, reconciledData, currentY);
    currentY = this.addESRS2Section(pdf, currentY, reconciledData);
    currentY = this.addESRSE1TransitionPlan(pdf, currentY, reconciledData);

    // PAGE 2: Emissions Overview and Targets
    pdf.addPage();
    this.addHeader(pdf, reconciledData);
    currentY = DESIGN.layout.margins.top;
    currentY = this.addESRSE1Targets(pdf, reconciledData, currentY);
    currentY = this.addEmissionsSummary(pdf, reconciledData, processedScope3, currentY);

    // PAGE 3: Detailed Emissions Table
    pdf.addPage();
    this.addHeader(pdf, reconciledData);
    currentY = DESIGN.layout.margins.top;
    currentY = this.addDetailedEmissionsTable(pdf, reconciledData, processedScope3, currentY);

    // PAGE 4: Scope 3 Categories
    if (processedScope3.some(cat => cat.emissions > 0)) {
      pdf.addPage();
      this.addHeader(pdf, reconciledData);
      currentY = DESIGN.layout.margins.top;
      currentY = this.addScope3Categories(pdf, processedScope3, currentY, reconciledData.summary.scope3);
    }

    // PAGE 5+: Activity Details
    if (reconciledData.activities && reconciledData.activities.length > 0) {
      pdf.addPage();
      this.addHeader(pdf, reconciledData);
      currentY = DESIGN.layout.margins.top;
      currentY = this.addActivityDetails(pdf, reconciledData, currentY);
    }

    // Add footer and page numbers
    // ESRS E1 Enhanced Sections
    // =========================
    
    // Data Quality Assessment
    pdf.addPage();
    currentY = DESIGN.layout.margins.top;
    currentY = this.addDataQualitySection(pdf, reconciledData, currentY);
    
    // Visual Analytics
    pdf.addPage();
    currentY = DESIGN.layout.margins.top;
    currentY = this.addEmissionsByScopeChart(pdf, reconciledData, currentY);
    
    pdf.addPage();
    currentY = DESIGN.layout.margins.top;
    currentY = this.addTopCategoriesChart(pdf, reconciledData, currentY);
    
    // ESRS E1 Mandatory Disclosures
    pdf.addPage();
    currentY = DESIGN.layout.margins.top;
    currentY = this.addEnergyConsumptionSection(pdf, reconciledData, currentY);
    
    currentY = this.addCarbonPricingSection(pdf, reconciledData, currentY);
    
    if (currentY > DESIGN.layout.pageHeight - 100) {
      pdf.addPage();
      currentY = DESIGN.layout.margins.top;
    }
    currentY = this.addClimateActionsSection(pdf, reconciledData, currentY);
    
    // Technical Analysis
    if (reconciledData.ghgBreakdown || reconciledData.results?.ghg_breakdown) {
      pdf.addPage();
      currentY = DESIGN.layout.margins.top;
      currentY = this.addGHGBreakdownSection(pdf, reconciledData, currentY);
    }
    
    if (reconciledData.uncertaintyAnalysis || reconciledData.results?.uncertainty_analysis) {
      pdf.addPage();
      currentY = DESIGN.layout.margins.top;
      currentY = this.addUncertaintyAnalysisSection(pdf, reconciledData, currentY);
    }

    this.addFooters(pdf, reconciledData);

    return pdf.output('blob');
  }

  /**
   * Calculate data quality score based on evidence and completeness
   */
  private calculateDataQuality(data: PDFExportData): number {
    let score = 0;
    let factors = 0;
    
    // Check scope completeness (40% weight)
    if (data.summary.scope1 > 0) { score += 10; factors++; }
    if (data.summary.scope2 > 0) { score += 10; factors++; }
    if (data.summary.scope3 > 0) { score += 10; factors++; }
    if (data.activities && data.activities.length > 10) { score += 10; factors++; }
    
    // Check evidence (30% weight)
    const evidenceCount = data.summary.evidenceCount || 0;
    if (evidenceCount > 0) { score += 10; factors++; }
    if (evidenceCount > 5) { score += 10; factors++; }
    if (evidenceCount > 10) { score += 10; factors++; }
    
    // Check data specificity (30% weight)
    const hasActivityData = data.activities && data.activities.some(a => a.dataQuality === 'high');
    const hasScope3Detail = data.scope3Analysis && data.scope3Analysis.some(s => s.emissions > 0);
    const hasFactors = data.activities && data.activities.some(a => a.factor && parseFloat(a.factor.toString()) > 0);
    
    if (hasActivityData) { score += 10; factors++; }
    if (hasScope3Detail) { score += 10; factors++; }
    if (hasFactors) { score += 10; factors++; }
    
    return factors > 0 ? Math.round((score / factors) * 10) : 0;
  }

  /**
   * Enhanced header with status indicators
   */
  private addHeader(pdf: jsPDF, data: PDFExportData): void {
    const { colors, typography } = DESIGN;
    const pageWidth = pdf.internal.pageSize.getWidth();
    
    // Header line
    pdf.setDrawColor(colors.lightGray.r, colors.lightGray.g, colors.lightGray.b);
    pdf.setLineWidth(0.5);
    pdf.line(DESIGN.layout.margins.left, 12, pageWidth - DESIGN.layout.margins.right, 12);
    
    // Compact header with key information
    pdf.setFontSize(typography.sizes.tiny);
    pdf.setTextColor(colors.gray.r, colors.gray.g, colors.gray.b);
    pdf.setFont(typography.fonts.primary, 'normal');
    
    // Left: Document ID and date
    const leftText = `${data.metadata.documentId} | ${new Date(data.metadata.generatedDate).toLocaleDateString()}`;
    pdf.text(leftText, DESIGN.layout.margins.left, 9);
    
    // Center: Company name
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.text(data.metadata.companyName, pageWidth / 2, 9, { align: 'center' });
    
    // Right: Standard and emissions
    pdf.setFont(typography.fonts.primary, 'normal');
    const rightText = `${data.metadata.standard || 'ESRS E1'} | ${data.summary.totalEmissions.toFixed(1)} tCO2e`;
    pdf.text(rightText, pageWidth - DESIGN.layout.margins.right, 9, { align: 'right' });
  }

  /**
   * Add document title
   */
  private addTitle(pdf: jsPDF, data: PDFExportData, y: number): number {
    const { colors, typography } = DESIGN;
    
    pdf.setFontSize(typography.sizes.h1);
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    pdf.setFont(typography.fonts.primary, 'bold');
    
    const title = `${data.metadata.companyName} - ESRS E1 Climate-related Disclosures`;
    pdf.text(title, DESIGN.layout.margins.left, y);
    
    // Professional underline
    const titleWidth = pdf.getTextWidth(title);
    pdf.setDrawColor(colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b);
    pdf.setLineWidth(1);
    pdf.line(DESIGN.layout.margins.left, y + 2, DESIGN.layout.margins.left + titleWidth, y + 2);
    
    return y + 15;
  }

  /**
   * Add report information section
   */
  private addReportInfo(pdf: jsPDF, data: PDFExportData, y: number): number {
    const { colors, typography } = DESIGN;
    
    pdf.setFontSize(typography.sizes.h2);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    pdf.text('Report Information', DESIGN.layout.margins.left, y);
    
    y += 10;
    
    const pageWidth = 210;
    const boxWidth = pageWidth - DESIGN.layout.margins.left - DESIGN.layout.margins.right;
    pdf.setFillColor(colors.offWhite.r, colors.offWhite.g, colors.offWhite.b);
    pdf.rect(DESIGN.layout.margins.left, y - 5, boxWidth, 35, 'F');
    
    pdf.setFontSize(typography.sizes.body);
    pdf.setFont(typography.fonts.primary, 'normal');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    
    const info = [
      `Reporting Period: ${data.metadata.reportingPeriod}`,
      `Publication Date: ${new Date(data.metadata.generatedDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`,
      `Standard Applied: ${data.metadata.standard || 'ESRS E1, GHG Protocol Corporate Value Chain (Scope 3) Standard'}`,
      `Methodology: ${data.metadata.methodology || 'Activity-based and spend-based hybrid approach'}`
    ];
    
    info.forEach((line, index) => {
      pdf.text(line, DESIGN.layout.margins.left + 5, y + (index * 6));
    });
    
    return y + 40;
  }

  /**
   * Add executive summary section
   */
  private addExecutiveSummary(pdf: jsPDF, data: PDFExportData, y: number): number {
    const { colors, typography, layout } = DESIGN;
    
    // Section header
    pdf.setFontSize(typography.sizes.h2);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b);
    pdf.text('Executive Summary', layout.margins.left, y);
    
    y += layout.spacing.subsection;
    
    // Key metrics box
    const boxHeight = 35;
    const pageWidth = 210;
    const boxWidth = pageWidth - layout.margins.left - layout.margins.right;
    
    // Green gradient background
    pdf.setFillColor(colors.lightGreen.r, colors.lightGreen.g, colors.lightGreen.b);
    pdf.rect(layout.margins.left, y - 5, boxWidth, boxHeight, 'F');
    
    // Metrics
    pdf.setFontSize(typography.sizes.small);
    pdf.setFont(typography.fonts.primary, 'normal');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    
    const col1X = layout.margins.left + 5;
    const col2X = layout.margins.left + boxWidth / 2;
    let lineY = y;
    
    // Column 1
    pdf.text(`Total Emissions: ${data.summary.totalEmissions.toFixed(2)} tCO2e`, col1X, lineY);
    lineY += layout.spacing.line;
    const qualityScore = data.summary.dataQualityScore || this.calculateDataQuality(data);
    pdf.text(`Data Quality Score: ${Math.round(qualityScore)}%`, col1X, lineY);
    lineY += layout.spacing.line;
    pdf.text(`Evidence Documents: ${data.summary.evidenceCount || 0}`, col1X, lineY);
    
    // Column 2
    lineY = y;
    pdf.text(`Scope 1: ${data.summary.scope1.toFixed(2)} tCO2e (${data.summary.scope1Percentage.toFixed(0)}%)`, col2X, lineY);
    lineY += layout.spacing.line;
    pdf.text(`Scope 2: ${data.summary.scope2.toFixed(2)} tCO2e (${data.summary.scope2Percentage.toFixed(0)}%)`, col2X, lineY);
    lineY += layout.spacing.line;
    pdf.text(`Scope 3: ${data.summary.scope3.toFixed(2)} tCO2e (${data.summary.scope3Percentage.toFixed(0)}%)`, col2X, lineY);
    
    return y + boxHeight + layout.spacing.section;
  }

  /**
   * Add ESRS 2 section
   */
  private addESRS2Section(pdf: jsPDF, y: number, data?: PDFExportData): number {
    const { colors, typography } = DESIGN;
    
    pdf.setFontSize(typography.sizes.h2);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    pdf.text('ESRS 2 - General Disclosures', DESIGN.layout.margins.left, y);
    
    y += 10;
    
    const pageWidth = 210;
    const boxWidth = pageWidth - DESIGN.layout.margins.left - DESIGN.layout.margins.right;
    pdf.setFillColor(colors.lightGreen.r, colors.lightGreen.g, colors.lightGreen.b);
    pdf.rect(DESIGN.layout.margins.left, y - 5, boxWidth, 28, 'F');
    
    pdf.setFontSize(typography.sizes.body);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b);
    pdf.text('GOV-1: The role of governance bodies', DESIGN.layout.margins.left + 5, y);
    
    pdf.setFont(typography.fonts.primary, 'normal');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    
    // Use actual data if available, otherwise show placeholder
    const boardOversight = (data && data.governanceData?.boardOversight) || 'Confirmed';
    const boardFrequency = (data && data.governanceData?.boardMeetingFrequency) || 'Quarterly';
    const mgmtResponsibilities = (data && data.governanceData?.managementResponsibilities) || 'Defined and operational';
    
    pdf.text(`Board oversight of climate-related issues: ${boardOversight}`, DESIGN.layout.margins.left + 5, y + 6);
    pdf.text(`Frequency of board climate discussions: ${boardFrequency}`, DESIGN.layout.margins.left + 5, y + 12);
    pdf.text(`Management climate responsibilities: ${mgmtResponsibilities}`, DESIGN.layout.margins.left + 5, y + 18);
    
    return y + 35;
  }

  /**
   * Add ESRS E1 transition plan section only
   */
  private addESRSE1TransitionPlan(pdf: jsPDF, y: number, data?: PDFExportData): number {
    const { colors, typography } = DESIGN;
    
    pdf.setFontSize(typography.sizes.h2);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    pdf.text('ESRS E1 - Climate Change', DESIGN.layout.margins.left, y);
    
    y += 10;
    
    const pageWidth = 210;
    const boxWidth = pageWidth - DESIGN.layout.margins.left - DESIGN.layout.margins.right;
    pdf.setFillColor(colors.lightGreen.r, colors.lightGreen.g, colors.lightGreen.b);
    pdf.rect(DESIGN.layout.margins.left, y - 5, boxWidth, 22, 'F');
    
    pdf.setFontSize(typography.sizes.body);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b);
    pdf.text('E1-1: Transition plan for climate change mitigation', DESIGN.layout.margins.left + 5, y);
    
    pdf.setFont(typography.fonts.primary, 'normal');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    
    // Use actual data if available
    const planAdopted = (data && data.transitionPlan?.adopted !== undefined) ? 
      (data.transitionPlan.adopted ? 'Yes' : 'No') : 'Yes';
    const aligned15C = (data && data.transitionPlan?.alignedWith15C !== undefined) ? 
      (data.transitionPlan.alignedWith15C ? 'Yes' : 'No') : 'Yes';
    
    pdf.text(`Transition plan adopted: ${planAdopted}`, DESIGN.layout.margins.left + 5, y + 6);
    pdf.text(`Aligned with 1.5°C pathway: ${aligned15C}`, DESIGN.layout.margins.left + 5, y + 12);
    
    return y + 28;
  }

  /**
   * Add ESRS E1 sections (wrapper for backward compatibility)
   */
  private addESRSE1Sections(pdf: jsPDF, data: PDFExportData, y: number): number {
    // Call the transition plan section
    y = this.addESRSE1TransitionPlan(pdf, y, data);
    
    // Add some spacing
    y += 15;
    
    // Call the targets section
    y = this.addESRSE1Targets(pdf, data, y);
    
    return y;
  }

  /**
   * Add ESRS E1 targets section
   */
  private addESRSE1Targets(pdf: jsPDF, data: PDFExportData, y: number): number {
    const { colors, typography } = DESIGN;
    
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b);
    pdf.text('E1-4: GHG emission reduction targets', DESIGN.layout.margins.left, y);
    
    y += 8;
    
    const targetData = [
      ['Absolute reduction', 'Scopes 1, 2 & 3', '2019', '2030', '50%', '25%', 'SBTi 1.5°C'],
      ['Intensity reduction', 'Scopes 1 & 2', '2019', '2025', '30%', '40%', 'Internal'],
      ['Net-zero target', 'All scopes', '2019', '2050', '90%', '10%', 'SBTi Net-Zero']
    ];
    
    (pdf as any).autoTable({
      startY: y,
      head: [['Target Type', 'Scope', 'Base Year', 'Target Year', 'Reduction', 'Progress', 'Validation']],
      body: targetData,
      theme: 'grid',
      headStyles: {
        fillColor: [colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b],
        textColor: 255,
        fontSize: typography.sizes.small,
        fontStyle: 'bold',
        cellPadding: 3
      },
      bodyStyles: {
        fontSize: typography.sizes.small,
        textColor: [colors.black.r, colors.black.g, colors.black.b],
        cellPadding: 3
      },
      columnStyles: {
        0: { cellWidth: 35 },
        1: { cellWidth: 28 },
        2: { cellWidth: 18 },
        3: { cellWidth: 20 },
        4: { cellWidth: 20 },
        5: { cellWidth: 20 },
        6: { cellWidth: 25 }
      },
      margin: { left: DESIGN.layout.margins.left, right: DESIGN.layout.margins.right }
    });
    
    return (pdf as any).lastAutoTable.finalY + 15;
  }

  /**
   * Add emissions summary visualization
   */
  private addEmissionsSummary(pdf: jsPDF, data: PDFExportData, scope3Data: Scope3Category[], y: number): number {
    const { colors, typography, layout } = DESIGN;
    
    // Section header
    pdf.setFontSize(typography.sizes.h2);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    pdf.text('Emissions Overview', layout.margins.left, y);
    
    y += layout.spacing.subsection;
    
    // Scope breakdown visualization (simple bar chart)
    // Uses summary data as source of truth
    const barHeight = 20;
    const barWidth = 150;
    const scopes = [
      { name: 'Scope 1', value: data.summary.scope1, percentage: data.summary.scope1Percentage },
      { name: 'Scope 2', value: data.summary.scope2, percentage: data.summary.scope2Percentage },
      { name: 'Scope 3', value: data.summary.scope3, percentage: data.summary.scope3Percentage }
    ];
    
    scopes.forEach((scope, index) => {
      const barY = y + (index * (barHeight + 5));
      
      // Label
      pdf.setFontSize(typography.sizes.body);
      pdf.setFont(typography.fonts.primary, 'normal');
      pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
      pdf.text(scope.name, layout.margins.left, barY + 4);
      
      // Background bar
      pdf.setFillColor(colors.lightGray.r, colors.lightGray.g, colors.lightGray.b);
      pdf.rect(layout.margins.left + 25, barY, barWidth, barHeight - 5, 'F');
      
      // Value bar
      const valueWidth = (scope.percentage / 100) * barWidth;
      pdf.setFillColor(colors.green.r, colors.green.g, colors.green.b);
      pdf.rect(layout.margins.left + 25, barY, valueWidth, barHeight - 5, 'F');
      
      // Value text
      pdf.setFontSize(typography.sizes.small);
      pdf.text(
        `${scope.value.toFixed(1)} tCO2e (${scope.percentage.toFixed(0)}%)`,
        layout.margins.left + 25 + barWidth + 5,
        barY + 4
      );
    });
    
    return y + (scopes.length * (barHeight + 5)) + layout.spacing.section;
  }

  /**
   * Enhanced detailed emissions table with fixed Scope 3 data
   * IMPORTANT: Uses summary data as source of truth, not recalculated values
   */
  private addDetailedEmissionsTable(pdf: jsPDF, data: PDFExportData, processedScope3: Scope3Category[], y: number): number {
    const { colors, typography } = DESIGN;
    
    // Section header
    pdf.setFontSize(typography.sizes.h2);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    pdf.text('E1-6: Gross Scopes 1, 2, 3 and Total GHG emissions', DESIGN.layout.margins.left, y);
    
    y += 10;
    
    // Prepare table data
    const tableData = [];
    
    // Scope 1 - with subcategories if available
    tableData.push(['Scope 1 - Direct emissions', '', '', '', '']);
    
    const scope1Categories = this.getScope1Breakdown(data);
    scope1Categories.forEach(cat => {
      if (cat.emissions > 0) {
        tableData.push([
          `   ${cat.name}`,
          cat.emissions.toFixed(3),
          cat.dataQuality,
          cat.method,
          'E1-6.53'
        ]);
      }
    });
    
    // Use SUMMARY data for Scope 1 total
    tableData.push(['Scope 1 Total', data.summary.scope1.toFixed(3), 'High', 'Direct measurement', 'E1-6.53']);
    tableData.push(['', '', '', '', '']);
    
    // Scope 2
    tableData.push(['Scope 2 - Indirect emissions from purchased energy', '', '', '', '']);
    tableData.push(['   Location-based', data.summary.scope2.toFixed(3), 'High', 'Grid average factors', 'E1-6.54']);
    if (data.summary.scope2Market !== undefined && data.summary.scope2Market !== null) {
      tableData.push(['   Market-based', data.summary.scope2Market.toFixed(3), 'High', 'Supplier-specific factors', 'E1-6.54']);
    }
    tableData.push(['', '', '', '', '']);
    
    // Scope 3 - using processed data for categories but summary for total
    tableData.push(['Scope 3 - Other indirect emissions (GHG Protocol Categories)', '', '', '', '']);
    
    processedScope3.forEach(cat => {
      let value = cat.emissions > 0 ? cat.emissions.toFixed(3) : 'N/A';
      let quality = cat.emissions > 0 ? cat.dataQuality : '-';
      let method = cat.emissions > 0 ? cat.calculationMethod : cat.notApplicableReason || 'Not calculated';
      
      tableData.push([
        `   ${cat.category}`,
        value,
        quality,
        method,
        'E1-6.55'
      ]);
    });
    
    tableData.push(['', '', '', '', '']);
    
    // Use SUMMARY data for Scope 3 total
    tableData.push(['Scope 3 Total', data.summary.scope3.toFixed(3), 'See categories', '', 'E1-6.55']);
    tableData.push(['', '', '', '', '']);
    
    // Use SUMMARY data for total emissions
    tableData.push(['Total GHG emissions', data.summary.totalEmissions.toFixed(3), 'Mixed', '', 'E1-6.56']);
    
    // Create table
    (pdf as any).autoTable({
      startY: y,
      head: [['GHG Emissions', 'Value (tCO2e)', 'Data Quality', 'Calculation Method', 'ESRS Ref']],
      body: tableData,
      theme: 'grid',
      headStyles: {
        fillColor: [colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b],
        textColor: 255,
        fontSize: typography.sizes.small,
        fontStyle: 'bold',
        cellPadding: 3
      },
      bodyStyles: {
        fontSize: typography.sizes.tiny,
        textColor: [colors.black.r, colors.black.g, colors.black.b],
        cellPadding: 2
      },
      alternateRowStyles: {
        fillColor: [250, 250, 250]
      },
      columnStyles: {
        0: { cellWidth: 70 },
        1: { cellWidth: 25, halign: 'right' },
        2: { cellWidth: 20, halign: 'center' },
        3: { cellWidth: 35 },
        4: { cellWidth: 17, halign: 'center' }
      },
      margin: { left: DESIGN.layout.margins.left, right: DESIGN.layout.margins.right },
      pageBreak: 'auto',
      showHead: 'everyPage',
      didParseCell: (data: any) => {
        // Style the total row
        if (data.row.index === tableData.length - 1 && data.section === 'body') {
          data.cell.styles.fillColor = [colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b];
          data.cell.styles.textColor = [255, 255, 255];
          data.cell.styles.fontStyle = 'bold';
        }
        // Style section headers
        if (data.cell.text[0] && data.cell.text[0].startsWith('Scope') && !data.cell.text[0].includes('   ')) {
          data.cell.styles.fontStyle = 'bold';
          data.cell.styles.fillColor = [colors.lightGreen.r, colors.lightGreen.g, colors.lightGreen.b];
        }
      }
    });
    
    return (pdf as any).lastAutoTable.finalY + 15;
  }

  /**
   * Get Scope 1 breakdown from activities
   * Ensures subcategories don't exceed summary total
   */
  private getScope1Breakdown(data: PDFExportData): Array<{name: string, emissions: number, dataQuality: string, method: string}> {
    const categories = [
      { name: 'Stationary Combustion', emissions: 0, dataQuality: 'High', method: 'Direct measurement' },
      { name: 'Mobile Combustion', emissions: 0, dataQuality: 'High', method: 'Direct measurement' },
      { name: 'Process Emissions', emissions: 0, dataQuality: 'High', method: 'Direct measurement' },
      { name: 'Fugitive Emissions', emissions: 0, dataQuality: 'High', method: 'Direct measurement' }
    ];
    
    if (data.activities) {
      data.activities.forEach(activity => {
        const category = categories.find(cat => cat.name === activity.categoryName);
        if (category) {
          const amount = this.parseNumber(activity.amount);
          const factor = this.parseNumber(activity.factor);
          
          // Check if emissions are pre-calculated
          let emissions = 0;
          if (activity.emissions !== undefined) {
            emissions = this.parseNumber(activity.emissions);
          } else {
            emissions = (amount * factor) / 1000;
          }
          
          category.emissions += emissions;
        }
      });
    }
    
    // Ensure subcategories don't exceed total
    const calculatedScope1 = categories.reduce((sum, cat) => sum + cat.emissions, 0);
    const summaryScope1 = data.summary.scope1;
    
    // If calculated exceeds summary, scale down proportionally
    if (calculatedScope1 > summaryScope1 && calculatedScope1 > 0) {
      const scaleFactor = summaryScope1 / calculatedScope1;
      categories.forEach(cat => {
        cat.emissions = cat.emissions * scaleFactor;
      });
    }
    
    return categories;
  }

  /**
   * Enhanced Scope 3 categories table
   */
  private addScope3Categories(pdf: jsPDF, scope3Data: Scope3Category[], y: number, summaryScope3Total?: number): number {
    const { colors, typography } = DESIGN;
    
    pdf.setFontSize(typography.sizes.h2);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    pdf.text('Scope 3 Categories - Detailed Analysis', DESIGN.layout.margins.left, y);
    
    y += 10;
    
    // Use summary total if provided, otherwise calculate from categories
    const totalScope3 = summaryScope3Total !== undefined ? summaryScope3Total :
      scope3Data.reduce((sum, cat) => sum + cat.emissions, 0);
    
    // Build table data
    const tableData = scope3Data.map(cat => {
      // Use simple text instead of Unicode symbols for better PDF compatibility
      let status = '';
      if (cat.emissions > 0) {
        status = 'Yes';
      } else if (cat.applicabilityStatus === 'not-applicable') {
        status = 'N/A';
      } else if (cat.applicabilityStatus === 'de-minimis') {
        status = '<1%';
      } else {
        status = 'No';
      }
      
      // Recalculate percentage based on the correct total
      const percentage = totalScope3 > 0 ? (cat.emissions / totalScope3) * 100 : 0;
      
      return [
        cat.category,
        cat.emissions > 0 ? cat.emissions.toFixed(3) : '-',
        cat.emissions > 0 ? `${percentage.toFixed(1)}%` : '-',
        cat.activities.toString(),
        cat.hasEvidence ? 'Yes' : 'No',
        status
      ];
    });
    
    (pdf as any).autoTable({
      startY: y,
      head: [['Category', 'tCO2e', '% Scope 3', 'Count', 'Docs', 'Status']],
      body: tableData,
      theme: 'grid',
      headStyles: {
        fillColor: [colors.green.r, colors.green.g, colors.green.b],
        textColor: 255,
        fontSize: typography.sizes.tiny,  // Smaller font for headers
        fontStyle: 'bold',
        cellPadding: 2.5  // Slightly less padding
      },
      bodyStyles: {
        fontSize: typography.sizes.small,
        cellPadding: 3
      },
      columnStyles: {
        0: { cellWidth: 62 },
        1: { cellWidth: 22, halign: 'right' },
        2: { cellWidth: 20, halign: 'right' },
        3: { cellWidth: 16, halign: 'center' },
        4: { cellWidth: 16, halign: 'center' },
        5: { cellWidth: 18, halign: 'center' }
      },
      margin: { left: DESIGN.layout.margins.left, right: DESIGN.layout.margins.right + 5 },  // Extra margin
      pageBreak: 'auto',
      showHead: 'everyPage',
      didParseCell: (data: any) => {
        // Color code status column
        if (data.column.index === 5 && data.section === 'body') {
          const status = data.cell.text[0];
          if (status === 'Yes') {
            data.cell.styles.textColor = [colors.success.r, colors.success.g, colors.success.b];
            data.cell.styles.fontStyle = 'bold';
          } else if (status === 'N/A') {
            data.cell.styles.textColor = [colors.gray.r, colors.gray.g, colors.gray.b];
            data.cell.styles.fontStyle = 'italic';
          } else if (status === '<1%') {
            data.cell.styles.textColor = [colors.gray.r, colors.gray.g, colors.gray.b];
            data.cell.styles.fontSize = typography.sizes.tiny;
          } else if (status === 'No') {
            data.cell.styles.textColor = [colors.warning.r, colors.warning.g, colors.warning.b];
          }
        }
      }
    });
    
    y = (pdf as any).lastAutoTable.finalY + 10;
    
    // Summary box
    pdf.setFillColor(colors.lightGreen.r, colors.lightGreen.g, colors.lightGreen.b);
    pdf.rect(DESIGN.layout.margins.left, y, 170, 12, 'F');
    
    pdf.setTextColor(colors.darkGreen.r, colors.darkGreen.g, colors.darkGreen.b);
    pdf.setFontSize(typography.sizes.body);
    pdf.setFont(typography.fonts.primary, 'bold');
    
    const applicableCount = scope3Data.filter(cat => cat.applicabilityStatus === 'applicable').length;
    const calculatedCount = scope3Data.filter(cat => cat.emissions > 0).length;
    
    pdf.text(`Total Scope 3: ${totalScope3.toFixed(3)} tCO2e`, DESIGN.layout.margins.left + 5, y + 5);
    pdf.text(`Categories: ${calculatedCount}/${applicableCount} calculated`, DESIGN.layout.margins.left + 5, y + 9);
    
    // Add legend
    y += 20;
    pdf.setFontSize(typography.sizes.tiny);
    pdf.setFont(typography.fonts.primary, 'italic');
    pdf.setTextColor(colors.gray.r, colors.gray.g, colors.gray.b);
    pdf.text('Status: Yes = Calculated | No = Not calculated | N/A = Not applicable | <1% = De minimis', 
      DESIGN.layout.margins.left, y);
    
    return y + 10;
  }

  /**
   * Add activity details with improved formatting
   */
  private addActivityDetails(pdf: jsPDF, data: PDFExportData, y: number): number {
    const { colors, typography } = DESIGN;
    
    pdf.setFontSize(typography.sizes.h2);
    pdf.setFont(typography.fonts.primary, 'bold');
    pdf.setTextColor(colors.black.r, colors.black.g, colors.black.b);
    pdf.text('Activity-level Emissions Data', DESIGN.layout.margins.left, y);
    
    y += 10;
    
    if (data.activities && data.activities.length > 0) {
      // Process and sort activities
      const processedActivities = data.activities
        .filter(a => this.parseNumber(a.amount) > 0)
        .map(activity => {
          const amount = this.parseNumber(activity.amount);
          const factor = this.parseNumber(activity.factor);
          
          // Use pre-calculated emissions if available
          let emissions = 0;
          if (activity.emissions !== undefined && activity.emissions !== null) {
            emissions = this.parseNumber(activity.emissions);
          } else {
            // Calculate emissions using standard formula
            emissions = (amount * factor) / 1000;
          }
          
          return {
            ...activity,
            calculatedEmissions: emissions,
            scope: this.determineScope(activity.categoryName)
          };
        })
        .sort((a, b) => b.calculatedEmissions - a.calculatedEmissions);
      
      // Group by scope
      const scopeGroups = {
        scope1: processedActivities.filter(a => a.scope === 'scope1'),
        scope2: processedActivities.filter(a => a.scope === 'scope2'),
        scope3: processedActivities.filter(a => a.scope === 'scope3')
      };
      
      // Prepare table data
      const tableData: any[] = [];
      
      ['scope1', 'scope2', 'scope3'].forEach(scope => {
        const activities = scopeGroups[scope as keyof typeof scopeGroups];
        if (activities.length > 0) {
          // Add scope header
          const scopeName = scope.charAt(0).toUpperCase() + scope.slice(1).replace(/(\d)/, ' $1');
          tableData.push([scopeName, '', '', '', '', '']);
          
          // Add top activities for this scope
          activities.slice(0, 20).forEach(activity => {
            tableData.push([
              activity.name || 'Unnamed activity',
              activity.categoryName || '',
              `${this.parseNumber(activity.amount).toLocaleString()}`,
              activity.unit || '',
              activity.factor ? this.parseNumber(activity.factor).toFixed(3) : '',
              activity.calculatedEmissions.toFixed(3)
            ]);
          });
        }
      });
      
      (pdf as any).autoTable({
        startY: y,
        head: [['Activity', 'Category', 'Qty', 'Unit', 'Factor', 'tCO2e']],
        body: tableData,
        theme: 'grid',
        headStyles: {
          fillColor: [colors.green.r, colors.green.g, colors.green.b],
          textColor: 255,
          fontSize: typography.sizes.tiny,  // Smaller font to prevent wrapping
          fontStyle: 'bold',
          cellPadding: 2.5  // Reduced padding
        },
        bodyStyles: {
          fontSize: typography.sizes.tiny,
          cellPadding: 2
        },
        columnStyles: {
          0: { cellWidth: 48 },
          1: { cellWidth: 44 },
          2: { cellWidth: 22, halign: 'right' },
          3: { cellWidth: 14 },
          4: { cellWidth: 18, halign: 'right' },
          5: { cellWidth: 18, halign: 'right' }
        },
        margin: { left: DESIGN.layout.margins.left, right: DESIGN.layout.margins.right + 5 },  // Extra margin to prevent edge issues
        pageBreak: 'auto',
        showHead: 'everyPage',
        didParseCell: (data: any) => {
          // Style scope headers
          if (data.cell.text[0] && data.cell.text[0].startsWith('Scope') && data.column.index === 0) {
            data.cell.styles.fontStyle = 'bold';
            data.cell.styles.fillColor = [colors.lightGreen.r, colors.lightGreen.g, colors.lightGreen.b];
            data.cell.colSpan = 6;
          }
        }
      });
      
      y = (pdf as any).lastAutoTable.finalY + 5;
      
      // Add summary note
      pdf.setFontSize(typography.sizes.tiny);
      pdf.setFont(typography.fonts.primary, 'italic');
      pdf.setTextColor(colors.gray.r, colors.gray.g, colors.gray.b);
      const totalActivities = processedActivities.length;
      const shownActivities = Math.min(totalActivities, 60);
      pdf.text(
        `Note: Showing top ${shownActivities} of ${totalActivities} activities, sorted by emissions impact.`,
        DESIGN.layout.margins.left,
        y
      );
    }
    
    return y + 10;
  }

  /**
   * Determine scope from category name
   */
  private determineScope(categoryName: string): string {
    if (!categoryName) return 'unknown';
    
    const scope1Categories = ['Stationary Combustion', 'Mobile Combustion', 'Process Emissions', 'Fugitive Emissions'];
    const scope2Categories = ['Purchased Electricity', 'Purchased Heat', 'Purchased Steam', 'Purchased Cooling', 
                             'Grid Electricity', 'District Heating', 'District Cooling'];
    
    if (scope1Categories.includes(categoryName)) return 'scope1';
    if (scope2Categories.some(cat => categoryName.includes(cat))) return 'scope2';
    if (categoryName.match(/^\d+\./)) return 'scope3';
    
    return 'unknown';
  }

  /**
   * Professional footer
   */
  private addFooters(pdf: jsPDF, data: PDFExportData): void {
    const pageCount = (pdf as any).getNumberOfPages();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const pageWidth = pdf.internal.pageSize.getWidth();
    
    for (let i = 1; i <= pageCount; i++) {
      pdf.setPage(i);
      
      // Footer line
      pdf.setDrawColor(DESIGN.colors.lightGray.r, DESIGN.colors.lightGray.g, DESIGN.colors.lightGray.b);
      pdf.setLineWidth(0.5);
      pdf.line(DESIGN.layout.margins.left, pageHeight - 15, pageWidth - DESIGN.layout.margins.right, pageHeight - 15);
      
      // Page number
      pdf.setFontSize(DESIGN.typography.sizes.small);
      pdf.setTextColor(DESIGN.colors.gray.r, DESIGN.colors.gray.g, DESIGN.colors.gray.b);
      pdf.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
      
      // Footer text
      pdf.setFontSize(DESIGN.typography.sizes.tiny);
      const footerText = `${data.metadata.companyName} | ESRS E1 Climate Disclosures | ${data.metadata.reportingPeriod}`;
      pdf.text(footerText, DESIGN.layout.margins.left, pageHeight - 10);
      
      // Version/Document ID
      const versionText = data.metadata.version || `v${this.version}`;
      pdf.text(versionText, pageWidth - DESIGN.layout.margins.right, pageHeight - 10, { align: 'right' });
    }
  }

  // Utility methods
  private createBatches<T>(items: T[], batchSize: number): T[][] {
    const batches: T[][] = [];
    for (let i = 0; i < items.length; i += batchSize) {
      batches.push(items.slice(i, i + batchSize));
    }
    return batches;
  }

  private delay(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  private downloadBlob(blob: Blob, filename: string): void {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
}

// Export convenience functions
export async function generatePDFReport(
  data: PDFExportData,
  options?: { useBackend?: boolean; filename?: string; compress?: boolean; validate?: boolean }
): Promise<ExportResult> {
  const handler = PDFExportHandler.getInstance();
  return handler.exportSinglePDF(data, options);
}

export function usePDFExport() {
  const [exporting, setExporting] = useState(false);
  const [progress, setProgress] = useState(0);
  const [currentDoc, setCurrentDoc] = useState('');
  const [results, setResults] = useState<ExportResult[]>([]);

  const exportSingle = async (data: PDFExportData, options?: any) => {
    setExporting(true);
    setProgress(0);
    
    try {
      const result = await generatePDFReport(data, options);
      setProgress(100);
      return result;
    } finally {
      setExporting(false);
    }
  };

  const exportBulk = async (documents: PDFExportData[], options?: any) => {
    setExporting(true);
    setProgress(0);
    setResults([]);

    const handler = PDFExportHandler.getInstance();
    try {
      const results = await handler.exportBulkPDFs({
        documents,
        ...options,
        onProgress: (prog, doc) => {
          setProgress(prog);
          setCurrentDoc(doc);
        },
        onComplete: (res) => {
          setResults(res);
        }
      });
      return results;
    } finally {
      setExporting(false);
    }
  };

  return {
    exportSingle,
    exportBulk,
    exporting,
    progress,
    currentDoc,
    results
  };
}

// Export types
export type { PDFExportData, ExportResult, EmissionActivity, Scope3Category, BulkExportOptions };

// Production-ready usage example:
/*
const pdfData: PDFExportData = {
  metadata: {
    companyName: "Your Company",
    reportingPeriod: "2025-07",
    generatedDate: new Date().toISOString(),
    documentId: "GHG-" + Math.random().toString(36).substr(2, 9),
    standard: "ESRS E1 Compliant"
  },
  summary: {
    totalEmissions: 100.5,      // Must equal scope1 + scope2 + scope3
    scope1: 10.5,              // Direct emissions
    scope2: 20.0,              // Indirect from energy
    scope3: 70.0,              // Other indirect
    scope1Percentage: 10.4,    // Will be recalculated
    scope2Percentage: 19.9,    // Will be recalculated  
    scope3Percentage: 69.7,    // Will be recalculated
    dataQualityScore: 85,
    evidenceCount: 12
  },
  activities: [
    {
      name: "Natural Gas Heating",
      categoryName: "Stationary Combustion",
      amount: 1000,
      unit: "kWh",
      factor: 0.185,
      emissions: 0.185  // Optional: pre-calculated
    }
  ],
  scope3Analysis: [
    {
      category: "1. Purchased goods and services",
      categoryNumber: 1,
      emissions: 25.5,
      activities: 15,
      hasEvidence: true,

  // ==========================================
  // ESRS E1 Enhanced Section Methods
  // ==========================================
  
  /**
   * Add Data Quality Assessment Section
   * Transparency requirement for ESRS E1
   */
  private addDataQualitySection(pdf: jsPDF, data: PDFExportData, startY: number): number {
    let currentY = startY;
    
    pdf.setFontSize(DESIGN.fonts.sizes.title);
    pdf.setTextColor(...DESIGN.colors.primary);
    pdf.text('Data Quality Assessment', DESIGN.layout.margins.left, currentY);
    currentY += 12;
    
    pdf.setFontSize(DESIGN.fonts.sizes.body);
    pdf.setTextColor(...DESIGN.colors.secondary);
    pdf.text('ESRS E1 requires transparency in data quality and calculation methodologies', DESIGN.layout.margins.left, currentY);
    currentY += 15;
    
    const qualityScore = data.dataQuality?.overallScore || data.summary.dataQualityScore || 0;
    const scoreColor = qualityScore >= 80 ? DESIGN.colors.success : qualityScore >= 60 ? DESIGN.colors.warning : DESIGN.colors.error;
    
    // Overall score box
    pdf.setFillColor(245, 245, 245);
    pdf.rect(DESIGN.layout.margins.left, currentY, 170, 30, 'F');
    
    pdf.setFontSize(24);
    pdf.setTextColor(...scoreColor);
    pdf.text(`${qualityScore.toFixed(0)}%`, DESIGN.layout.margins.left + 10, currentY + 20);
    
    pdf.setFontSize(12);
    pdf.setTextColor(...DESIGN.colors.text);
    pdf.text('Overall Data Quality Score', DESIGN.layout.margins.left + 60, currentY + 20);
    currentY += 40;
    
    // Detailed metrics
    if (data.dataQuality) {
      const metrics = [
        ['Data Completeness', data.dataQuality.dataCompleteness, 'Percentage of required data fields provided'],
        ['Evidence Coverage', data.dataQuality.evidenceProvided, 'Activities with supporting documentation'],
        ['Data Recency', data.dataQuality.dataRecency, 'How current the data is'],
        ['Methodology Accuracy', data.dataQuality.methodologyAccuracy, 'Use of recognized emission factors']
      ];
      
      (pdf as any).autoTable({
        startY: currentY,
        head: [['Metric', 'Score', 'Description']],
        body: metrics.map(m => [m[0], `${(m[1] as number).toFixed(0)}%`, m[2]]),
        theme: 'grid',
        headStyles: { fillColor: DESIGN.colors.primary },
        columnStyles: {
          1: { halign: 'center', cellWidth: 30 },
        },
        margin: { left: DESIGN.layout.margins.left }
      });
      
      currentY = (pdf as any).lastAutoTable.finalY + 10;
    }
    
    return currentY;
  }

  /**
   * Add Emissions by Scope Visualization
   */
  private addEmissionsByScopeChart(pdf: jsPDF, data: PDFExportData, startY: number): number {
    let currentY = startY;
    
    pdf.setFontSize(DESIGN.fonts.sizes.title);
    pdf.setTextColor(...DESIGN.colors.primary);
    pdf.text('Emissions by Scope', DESIGN.layout.margins.left, currentY);
    currentY += 12;
    
    pdf.setFontSize(DESIGN.fonts.sizes.body);
    pdf.setTextColor(...DESIGN.colors.secondary);
    pdf.text('Distribution of emissions across GHG Protocol scopes', DESIGN.layout.margins.left, currentY);
    currentY += 20;
    
    const total = data.summary.totalEmissions || 0;
    const scopes = [
      { name: 'Scope 1 - Direct', value: data.summary.scope1, percentage: data.summary.scope1Percentage, color: DESIGN.colors.error },
      { name: 'Scope 2 - Energy', value: data.summary.scope2, percentage: data.summary.scope2Percentage, color: DESIGN.colors.warning },
      { name: 'Scope 3 - Value Chain', value: data.summary.scope3, percentage: data.summary.scope3Percentage, color: DESIGN.colors.success }
    ];
    
    // Visual bar chart
    const barHeight = 30;
    const maxWidth = 150;
    
    scopes.forEach((scope, index) => {
      const yPos = currentY + (index * (barHeight + 10));
      const barWidth = total > 0 ? (scope.value / total) * maxWidth : 0;
      
      // Scope name and value
      pdf.setFontSize(12);
      pdf.setTextColor(...DESIGN.colors.text);
      pdf.text(scope.name, DESIGN.layout.margins.left, yPos + 20);
      
      // Bar
      pdf.setFillColor(...scope.color);
      pdf.rect(DESIGN.layout.margins.left, yPos + 25, barWidth, barHeight, 'F');
      
      // Percentage and value
      pdf.setFontSize(11);
      pdf.text(`${scope.percentage.toFixed(1)}%`, DESIGN.layout.margins.left + 160, yPos + 20);
      pdf.text(`${scope.value.toFixed(2)} tCO₂e`, DESIGN.layout.margins.left + 160, yPos + 35);
    });
    
    currentY += (3 * (barHeight + 10)) + 20;
    
    // Summary table
    (pdf as any).autoTable({
      startY: currentY,
      head: [['Scope', 'Emissions (tCO₂e)', 'Percentage', 'Key Sources']],
      body: [
        ['Scope 1', data.summary.scope1.toFixed(2), `${data.summary.scope1Percentage.toFixed(1)}%`, 'Fuel combustion, processes'],
        ['Scope 2', data.summary.scope2.toFixed(2), `${data.summary.scope2Percentage.toFixed(1)}%`, 'Purchased electricity, heat'],
        ['Scope 3', data.summary.scope3.toFixed(2), `${data.summary.scope3Percentage.toFixed(1)}%`, 'Supply chain, travel, waste'],
        ['Total', data.summary.totalEmissions.toFixed(2), '100.0%', '']
      ],
      theme: 'striped',
      headStyles: { fillColor: DESIGN.colors.primary },
      footStyles: { fontStyle: 'bold' },
      margin: { left: DESIGN.layout.margins.left }
    });
    
    return (pdf as any).lastAutoTable.finalY + 10;
  }

  /**
   * Add Top Emission Categories
   */
  private addTopCategoriesChart(pdf: jsPDF, data: PDFExportData, startY: number): number {
    let currentY = startY;
    
    pdf.setFontSize(DESIGN.fonts.sizes.title);
    pdf.setTextColor(...DESIGN.colors.primary);
    pdf.text('Top Emission Categories', DESIGN.layout.margins.left, currentY);
    currentY += 12;
    
    pdf.setFontSize(DESIGN.fonts.sizes.body);
    pdf.setTextColor(...DESIGN.colors.secondary);
    pdf.text('Highest contributing activities for materiality assessment', DESIGN.layout.margins.left, currentY);
    currentY += 20;
    
    if (data.topEmissionSources && data.topEmissionSources.length > 0) {
      const tableData = data.topEmissionSources.slice(0, 10).map((source, index) => [
        `${index + 1}`,
        source.name.substring(0, 40),
        source.category,
        `${source.emissions.toFixed(3)}`,
        `${source.percentage.toFixed(1)}%`
      ]);
      
      (pdf as any).autoTable({
        startY: currentY,
        head: [['Rank', 'Activity', 'Category', 'tCO₂e', '% of Total']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: DESIGN.colors.primary },
        columnStyles: {
          0: { cellWidth: 15, halign: 'center' },
          3: { halign: 'right' },
          4: { halign: 'center' }
        },
        margin: { left: DESIGN.layout.margins.left }
      });
      
      currentY = (pdf as any).lastAutoTable.finalY + 15;
      
      // Visual representation of top 5
      const top5 = data.topEmissionSources.slice(0, 5);
      if (top5.length > 0) {
        const maxEmission = Math.max(...top5.map(s => s.emissions));
        
        pdf.setFontSize(12);
        pdf.setTextColor(...DESIGN.colors.primary);
        pdf.text('Top 5 Emission Sources - Visual Breakdown', DESIGN.layout.margins.left, currentY);
        currentY += 10;
        
        top5.forEach((source, index) => {
          const barWidth = (source.emissions / maxEmission) * 120;
          const yPos = currentY + (index * 25);
          
          pdf.setFontSize(10);
          pdf.setTextColor(...DESIGN.colors.text);
          pdf.text(source.name.substring(0, 30), DESIGN.layout.margins.left, yPos + 15);
          
          // Gradient effect with scope colors
          const color = index === 0 ? DESIGN.colors.error : index === 1 ? DESIGN.colors.warning : DESIGN.colors.success;
          pdf.setFillColor(...color);
          pdf.rect(DESIGN.layout.margins.left + 100, yPos + 10, barWidth, 15, 'F');
          
          pdf.text(`${source.emissions.toFixed(2)} tCO₂e`, DESIGN.layout.margins.left + 225, yPos + 15);
        });
        
        currentY += (5 * 25) + 10;
      }
    }
    
    return currentY;
  }

  /**
   * ESRS E1-5: Energy Consumption
   */
  private addEnergyConsumptionSection(pdf: jsPDF, data: PDFExportData, startY: number): number {
    let currentY = startY;
    
    pdf.setFontSize(DESIGN.fonts.sizes.title);
    pdf.setTextColor(...DESIGN.colors.primary);
    pdf.text('ESRS E1-5: Energy Consumption', DESIGN.layout.margins.left, currentY);
    currentY += 12;
    
    pdf.setFontSize(DESIGN.fonts.sizes.body);
    pdf.setTextColor(...DESIGN.colors.secondary);
    pdf.text('Energy consumption and renewable energy share (§67-69)', DESIGN.layout.margins.left, currentY);
    currentY += 20;
    
    const energyData = data.esrsE1Data?.energy_consumption;
    
    if (energyData) {
      const totalEnergy = (energyData.electricity_mwh || 0) + 
                         (energyData.heating_cooling_mwh || 0) + 
                         (energyData.steam_mwh || 0) + 
                         (energyData.fuel_combustion_mwh || 0);
      const renewablePercentage = totalEnergy > 0 ? 
        ((energyData.renewable_energy_mwh || 0) / totalEnergy * 100) : 0;
      
      const energyTable = [
        ['Energy Type', 'Consumption (MWh)', 'Percentage'],
        ['Electricity', (energyData.electricity_mwh || 0).toFixed(1), 
         totalEnergy > 0 ? `${((energyData.electricity_mwh || 0) / totalEnergy * 100).toFixed(1)}%` : '0%'],
        ['Heating & Cooling', (energyData.heating_cooling_mwh || 0).toFixed(1),
         totalEnergy > 0 ? `${((energyData.heating_cooling_mwh || 0) / totalEnergy * 100).toFixed(1)}%` : '0%'],
        ['Steam', (energyData.steam_mwh || 0).toFixed(1),
         totalEnergy > 0 ? `${((energyData.steam_mwh || 0) / totalEnergy * 100).toFixed(1)}%` : '0%'],
        ['Fuel Combustion', (energyData.fuel_combustion_mwh || 0).toFixed(1),
         totalEnergy > 0 ? `${((energyData.fuel_combustion_mwh || 0) / totalEnergy * 100).toFixed(1)}%` : '0%'],
        ['Total', totalEnergy.toFixed(1), '100.0%'],
        ['Renewable Energy', (energyData.renewable_energy_mwh || 0).toFixed(1), `${renewablePercentage.toFixed(1)}%`]
      ];
      
      (pdf as any).autoTable({
        startY: currentY,
        body: energyTable,
        theme: 'grid',
        headStyles: { fillColor: DESIGN.colors.primary },
        columnStyles: {
          1: { halign: 'right' },
          2: { halign: 'center' }
        },
        didParseCell: (data: any) => {
          if (data.row.index === 5 || data.row.index === 6) {
            data.cell.styles.fontStyle = 'bold';
          }
        },
        margin: { left: DESIGN.layout.margins.left }
      });
      
      currentY = (pdf as any).lastAutoTable.finalY + 10;
      
      if (energyData.energy_intensity_value) {
        pdf.setFontSize(11);
        pdf.setTextColor(...DESIGN.colors.text);
        pdf.text(`Energy Intensity: ${energyData.energy_intensity_value.toFixed(2)} ${energyData.energy_intensity_unit || 'MWh/million EUR'}`, 
          DESIGN.layout.margins.left, currentY);
        currentY += 10;
      }
    } else {
      pdf.setFontSize(11);
      pdf.setTextColor(...DESIGN.colors.text);
      pdf.text('Total energy consumption: 0 MWh', DESIGN.layout.margins.left, currentY);
      currentY += 8;
      pdf.text('Renewable energy: 0%', DESIGN.layout.margins.left, currentY);
      currentY += 10;
      pdf.setFontSize(10);
      pdf.setTextColor(...DESIGN.colors.secondary);
      pdf.text('Note: Energy consumption captured under Scope 2 purchased electricity', DESIGN.layout.margins.left, currentY);
      currentY += 10;
    }
    
    return currentY;
  }
  
  /**
   * ESRS E1-8: Internal Carbon Pricing
   */
  private addCarbonPricingSection(pdf: jsPDF, data: PDFExportData, startY: number): number {
    let currentY = startY;
    
    currentY += 15; // Add spacing
    
    pdf.setFontSize(DESIGN.fonts.sizes.title);
    pdf.setTextColor(...DESIGN.colors.primary);
    pdf.text('ESRS E1-8: Internal Carbon Pricing', DESIGN.layout.margins.left, currentY);
    currentY += 12;
    
    pdf.setFontSize(DESIGN.fonts.sizes.body);
    pdf.setTextColor(...DESIGN.colors.secondary);
    pdf.text('Carbon pricing mechanisms and coverage (§77)', DESIGN.layout.margins.left, currentY);
    currentY += 20;
    
    const carbonPricing = data.esrsE1Data?.internal_carbon_pricing;
    
    const pricingData = [
      ['Attribute', 'Value'],
      ['Implementation Status', carbonPricing?.implemented ? 'Implemented' : 'Not implemented'],
      ['Carbon Price', carbonPricing?.implemented ? 
        `€${(carbonPricing.price_per_tco2e || 0).toFixed(2)}/tCO₂e` : '€0/tCO₂e'],
      ['Pricing Type', carbonPricing?.pricing_type || 'Not applicable'],
      ['Scope 1 Coverage', carbonPricing?.coverage_scope1 ? 'Yes' : 'No'],
      ['Scope 2 Coverage', carbonPricing?.coverage_scope2 ? 'Yes' : 'No'],
      ['Scope 3 Categories Covered', 
        (carbonPricing?.coverage_scope3_categories?.length || 0).toString()]
    ];
    
    (pdf as any).autoTable({
      startY: currentY,
      body: pricingData,
      theme: 'striped',
      headStyles: { fillColor: DESIGN.colors.primary },
      columnStyles: {
        0: { fontStyle: 'bold', cellWidth: 80 }
      },
      margin: { left: DESIGN.layout.margins.left }
    });
    
    currentY = (pdf as any).lastAutoTable.finalY + 10;
    
    if (!carbonPricing?.implemented) {
      pdf.setFontSize(10);
      pdf.setTextColor(...DESIGN.colors.secondary);
      pdf.text('Note: Internal carbon pricing not currently implemented. Consider establishing a shadow price', 
        DESIGN.layout.margins.left, currentY);
      currentY += 6;
      pdf.text('to support investment decisions and climate risk assessment.', DESIGN.layout.margins.left, currentY);
      currentY += 10;
    }
    
    return currentY;
  }

  /**
   * ESRS E1-3: Actions and Resources
   */
  private addClimateActionsSection(pdf: jsPDF, data: PDFExportData, startY: number): number {
    let currentY = startY;
    
    currentY += 15; // Add spacing
    
    pdf.setFontSize(DESIGN.fonts.sizes.title);
    pdf.setTextColor(...DESIGN.colors.primary);
    pdf.text('ESRS E1-3: Actions and Resources', DESIGN.layout.margins.left, currentY);
    currentY += 12;
    
    pdf.setFontSize(DESIGN.fonts.sizes.body);
    pdf.setTextColor(...DESIGN.colors.secondary);
    pdf.text('Climate-related expenditures and resources (§29-34)', DESIGN.layout.margins.left, currentY);
    currentY += 20;
    
    const climateActions = data.esrsE1Data?.climate_actions;
    const capex = climateActions?.capex_climate_eur || 0;
    const opex = climateActions?.opex_climate_eur || 0;
    const totalFinance = capex + opex;
    
    const actionsData = [
      ['Financial Metric', 'Amount (EUR)', 'Notes'],
      ['Climate-related CapEx', capex.toLocaleString(), 'Capital expenditures for climate mitigation'],
      ['Climate-related OpEx', opex.toLocaleString(), 'Operating expenses for climate actions'],
      ['Total Climate Finance', totalFinance.toLocaleString(), 'Combined CapEx and OpEx'],
      ['', '', ''],
      ['Human Resources', 'FTEs', ''],
      ['Dedicated Staff', (climateActions?.fte_dedicated || 0).toFixed(1), 'Full-time equivalents on climate']
    ];
    
    (pdf as any).autoTable({
      startY: currentY,
      body: actionsData,
      theme: 'grid',
      headStyles: { fillColor: DESIGN.colors.primary },
      columnStyles: {
        1: { halign: 'right' }
      },
      didParseCell: (data: any) => {
        if (data.row.index === 3 || data.row.index === 6) {
          data.cell.styles.fontStyle = 'bold';
        }
        if (data.row.index === 4 || data.row.index === 5) {
          data.cell.styles.fillColor = [245, 245, 245];
        }
      },
      margin: { left: DESIGN.layout.margins.left }
    });
    
    currentY = (pdf as any).lastAutoTable.finalY + 10;
    
    if (totalFinance === 0) {
      pdf.setFontSize(10);
      pdf.setTextColor(...DESIGN.colors.secondary);
      pdf.text('Note: No climate-related expenditures reported. ESRS E1 requires disclosure of climate', 
        DESIGN.layout.margins.left, currentY);
      currentY += 6;
      pdf.text('investments. Consider tracking green CapEx and OpEx for future reporting periods.', 
        DESIGN.layout.margins.left, currentY);
      currentY += 10;
    }
    
    return currentY;
  }
  
  /**
   * GHG Breakdown by Gas Type
   */
  private addGHGBreakdownSection(pdf: jsPDF, data: PDFExportData, startY: number): number {
    let currentY = startY;
    
    pdf.setFontSize(DESIGN.fonts.sizes.title);
    pdf.setTextColor(...DESIGN.colors.primary);
    pdf.text('GHG Breakdown by Gas Type', DESIGN.layout.margins.left, currentY);
    currentY += 12;
    
    pdf.setFontSize(DESIGN.fonts.sizes.body);
    pdf.setTextColor(...DESIGN.colors.secondary);
    pdf.text('Individual greenhouse gas emissions as required by ESRS E1-6 §53', DESIGN.layout.margins.left, currentY);
    currentY += 20;
    
    const ghgBreakdown = data.ghgBreakdown || data.results?.ghg_breakdown;
    
    if (ghgBreakdown) {
      const ghgData = [
        ['Greenhouse Gas', 'Chemical Formula', 'Emissions', 'Unit', 'GWP'],
        ['Carbon Dioxide', 'CO₂', ghgBreakdown.CO2_tonnes.toFixed(2), 'tonnes', '1'],
        ['Methane', 'CH₄', ghgBreakdown.CH4_tonnes.toFixed(3), 'tonnes', '28'],
        ['Nitrous Oxide', 'N₂O', ghgBreakdown.N2O_tonnes.toFixed(3), 'tonnes', '265']
      ];
      
      if (ghgBreakdown.HFCs_tonnes_co2e && ghgBreakdown.HFCs_tonnes_co2e > 0) {
        ghgData.push(['Hydrofluorocarbons', 'HFCs', ghgBreakdown.HFCs_tonnes_co2e.toFixed(3), 'tCO₂e', 'Various']);
      }
      
      ghgData.push(['', '', '', '', '']);
      ghgData.push(['Total CO₂ Equivalent', '', ghgBreakdown.total_co2e.toFixed(2), 'tCO₂e', '']);
      
      (pdf as any).autoTable({
        startY: currentY,
        head: [ghgData[0]],
        body: ghgData.slice(1),
        theme: 'grid',
        headStyles: { fillColor: DESIGN.colors.primary },
        columnStyles: {
          2: { halign: 'right' },
          4: { halign: 'center' }
        },
        didParseCell: (data: any) => {
          if (data.row.index === ghgData.length - 2) {
            data.cell.styles.fontStyle = 'bold';
          }
        },
        margin: { left: DESIGN.layout.margins.left }
      });
      
      currentY = (pdf as any).lastAutoTable.finalY + 10;
      
      pdf.setFontSize(10);
      pdf.setTextColor(...DESIGN.colors.secondary);
      pdf.text(`GWP Version: ${ghgBreakdown.gwp_version}`, DESIGN.layout.margins.left, currentY);
      currentY += 6;
      pdf.text('Global Warming Potential values based on IPCC Fifth Assessment Report (AR5)', 
        DESIGN.layout.margins.left, currentY);
      currentY += 10;
    } else {
      pdf.setFontSize(11);
      pdf.setTextColor(...DESIGN.colors.text);
      pdf.text('GHG breakdown by gas type not calculated.', DESIGN.layout.margins.left, currentY);
      currentY += 8;
      pdf.text('Enable gas breakdown in calculation settings to comply with ESRS E1-6 §53.', 
        DESIGN.layout.margins.left, currentY);
      currentY += 10;
    }
    
    return currentY;
  }
  
  /**
   * Uncertainty Analysis
   */
  private addUncertaintyAnalysisSection(pdf: jsPDF, data: PDFExportData, startY: number): number {
    let currentY = startY;
    
    pdf.setFontSize(DESIGN.fonts.sizes.title);
    pdf.setTextColor(...DESIGN.colors.primary);
    pdf.text('Uncertainty Analysis', DESIGN.layout.margins.left, currentY);
    currentY += 12;
    
    pdf.setFontSize(DESIGN.fonts.sizes.body);
    pdf.setTextColor(...DESIGN.colors.secondary);
    pdf.text('Statistical uncertainty assessment as per ESRS E1 §52', DESIGN.layout.margins.left, currentY);
    currentY += 20;
    
    const uncertainty = data.uncertaintyAnalysis || data.results?.uncertainty_analysis;
    
    if (uncertainty && uncertainty.confidence_interval_95) {
      const analysisData = [
        ['Statistical Measure', 'Value', 'Unit'],
        ['Mean Emissions', ((uncertainty.mean_emissions || 0) / 1000).toFixed(2), 'tCO₂e'],
        ['Standard Deviation', ((uncertainty.std_deviation || 0) / 1000).toFixed(2), 'tCO₂e'],
        ['95% Confidence Interval - Lower', (uncertainty.confidence_interval_95[0] / 1000).toFixed(2), 'tCO₂e'],
        ['95% Confidence Interval - Upper', (uncertainty.confidence_interval_95[1] / 1000).toFixed(2), 'tCO₂e'],
        ['Relative Uncertainty', `±${uncertainty.relative_uncertainty_percent?.toFixed(1) || 'N/A'}`, '%'],
        ['Monte Carlo Iterations', (uncertainty.monte_carlo_runs || 0).toLocaleString(), 'runs']
      ];
      
      (pdf as any).autoTable({
        startY: currentY,
        head: [analysisData[0]],
        body: analysisData.slice(1),
        theme: 'striped',
        headStyles: { fillColor: DESIGN.colors.primary },
        columnStyles: {
          1: { halign: 'right' },
          2: { halign: 'center' }
        },
        margin: { left: DESIGN.layout.margins.left }
      });
      
      currentY = (pdf as any).lastAutoTable.finalY + 15;
      
      // Visual uncertainty range
      pdf.setFontSize(12);
      pdf.setTextColor(...DESIGN.colors.primary);
      pdf.text('Emissions Uncertainty Range', DESIGN.layout.margins.left, currentY);
      currentY += 10;
      
      const reported = data.summary.totalEmissions;
      const lower = uncertainty.confidence_interval_95[0] / 1000;
      const upper = uncertainty.confidence_interval_95[1] / 1000;
      const range = upper - lower;
      
      // Draw uncertainty bar
      const barY = currentY;
      const barHeight = 20;
      const barWidth = 150;
      
      // Background
      pdf.setFillColor(240, 240, 240);
      pdf.rect(DESIGN.layout.margins.left, barY, barWidth, barHeight, 'F');
      
      // Confidence interval
      const lowerX = DESIGN.layout.margins.left;
      const upperX = DESIGN.layout.margins.left + barWidth;
      const reportedX = DESIGN.layout.margins.left + ((reported - lower) / range) * barWidth;
      
      pdf.setFillColor(...DESIGN.colors.warning);
      pdf.rect(lowerX, barY, upperX - lowerX, barHeight, 'F');
      
      // Reported value line
      pdf.setDrawColor(...DESIGN.colors.error);
      pdf.setLineWidth(2);
      pdf.line(reportedX, barY - 5, reportedX, barY + barHeight + 5);
      
      // Labels
      pdf.setFontSize(9);
      pdf.setTextColor(...DESIGN.colors.text);
      pdf.text(lower.toFixed(1), DESIGN.layout.margins.left, barY + barHeight + 15);
      pdf.text(upper.toFixed(1), DESIGN.layout.margins.left + barWidth - 20, barY + barHeight + 15);
      pdf.setTextColor(...DESIGN.colors.error);
      pdf.text(`Reported: ${reported.toFixed(1)}`, reportedX - 20, barY - 10);
      
      currentY += 50;
      
      pdf.setFontSize(10);
      pdf.setTextColor(...DESIGN.colors.secondary);
      pdf.text('The uncertainty analysis provides a statistical assessment of the reliability of emissions calculations.', 
        DESIGN.layout.margins.left, currentY);
      currentY += 6;
      pdf.text('This transparency supports stakeholder confidence and informed decision-making.', 
        DESIGN.layout.margins.left, currentY);
      currentY += 10;
    } else {
      pdf.setFontSize(11);
      pdf.setTextColor(...DESIGN.colors.text);
      pdf.text('Uncertainty analysis not performed.', DESIGN.layout.margins.left, currentY);
      currentY += 8;
      pdf.text('Enable Monte Carlo simulation to provide uncertainty estimates as recommended by ESRS E1 §52.', 
        DESIGN.layout.margins.left, currentY);
      currentY += 10;
    }
    
    return currentY;
  }
      percentage: 36.4,
      dataQuality: "Medium",
      calculationMethod: "Spend-based"
    }
  ]
};

// Generate PDF
const result = await generatePDFReport(pdfData, {
  filename: "emissions_report_2025.pdf",
  compress: true,
  validate: true
});
*/