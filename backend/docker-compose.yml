# ==============================================================================
# FactorTrace - Docker Compose Configuration
# ==============================================================================
# Full-stack deployment with API, PostgreSQL, and Redis
#
# Usage:
#   Development:  docker-compose up
#   Production:   docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#   Build:        docker-compose build
#   Logs:         docker-compose logs -f api
# ==============================================================================

version: "3.9"

services:
  # ----------------------------------------------------------------------------
  # FactorTrace API Service
  # ----------------------------------------------------------------------------
  api:
    container_name: factortrace-api
    build:
      context: ..
      dockerfile: backend/Dockerfile
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      # Application
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - APP_NAME=FactorTrace
      - APP_VERSION=1.0.0
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Database
      - DATABASE_URL=postgresql://${POSTGRES_USER:-factortrace}:${POSTGRES_PASSWORD:-factortrace_dev}@postgres:5432/${POSTGRES_DB:-factortrace}

      # Redis
      - REDIS_URL=redis://redis:6379/0

      # Authentication
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-30}

      # CORS
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}

      # Optional: Supabase (if using)
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_KEY=${SUPABASE_KEY:-}

      # Optional: Stripe
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}

      # Optional: Email
      - SENDGRID_API_KEY=${SENDGRID_API_KEY:-}

      # Optional: Sentry
      - SENTRY_DSN=${SENTRY_DSN:-}

      # Rate Limiting
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-true}
      - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS:-100}
      - RATE_LIMIT_PERIOD=${RATE_LIMIT_PERIOD:-60}
    volumes:
      # Persist uploads
      - factortrace-uploads:/app/uploads
      # Persist logs (optional, usually use log aggregation in prod)
      - factortrace-logs:/app/logs
      # Mount data directory for emission factors (read-only)
      - ./data:/app/data:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - factortrace-network

  # ----------------------------------------------------------------------------
  # PostgreSQL Database
  # ----------------------------------------------------------------------------
  postgres:
    container_name: factortrace-postgres
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-factortrace}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-factortrace_dev}
      - POSTGRES_DB=${POSTGRES_DB:-factortrace}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - factortrace-postgres-data:/var/lib/postgresql/data
      # Optional: initialization scripts
      - ./scripts/init-db:/docker-entrypoint-initdb.d:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-factortrace} -d ${POSTGRES_DB:-factortrace}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - factortrace-network

  # ----------------------------------------------------------------------------
  # Redis Cache
  # ----------------------------------------------------------------------------
  redis:
    container_name: factortrace-redis
    image: redis:7-alpine
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - factortrace-redis-data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    networks:
      - factortrace-network

  # ----------------------------------------------------------------------------
  # Database Migrations (run once then exit)
  # ----------------------------------------------------------------------------
  migrations:
    container_name: factortrace-migrations
    build:
      context: ..
      dockerfile: backend/Dockerfile
    command: ["alembic", "upgrade", "head"]
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-factortrace}:${POSTGRES_PASSWORD:-factortrace_dev}@postgres:5432/${POSTGRES_DB:-factortrace}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - factortrace-network
    restart: "no"

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  factortrace-postgres-data:
    driver: local
  factortrace-redis-data:
    driver: local
  factortrace-uploads:
    driver: local
  factortrace-logs:
    driver: local

# ==============================================================================
# Networks
# ==============================================================================
networks:
  factortrace-network:
    driver: bridge
    name: factortrace-network
