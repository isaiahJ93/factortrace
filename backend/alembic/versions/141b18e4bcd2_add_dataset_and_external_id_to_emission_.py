"""add dataset and external_id to emission_factors

Revision ID: 141b18e4bcd2
Revises: 83e7815eabd8
Create Date: 2025-11-28 03:23:37.650492

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '141b18e4bcd2'
down_revision: Union[str, Sequence[str], None] = '83e7815eabd8'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###

    # Step 1: Add columns with server_default for existing rows
    op.add_column('emission_factors', sa.Column('dataset', sa.String(length=50), nullable=False, server_default='MASTER'))
    op.add_column('emission_factors', sa.Column('external_id', sa.String(length=100), nullable=True))

    # Step 2: Drop old unique constraint (if exists - handle SQLite limitations)
    # SQLite doesn't support dropping constraints directly, so we use batch mode
    with op.batch_alter_table('emission_factors', schema=None) as batch_op:
        # Try to drop old constraint - may not exist on fresh installs
        try:
            batch_op.drop_constraint('uq_emission_factor_lookup', type_='unique')
        except Exception:
            pass  # Constraint may not exist on fresh installs

    # Step 3: Create indexes
    op.create_index('idx_factor_dataset', 'emission_factors', ['dataset'], unique=False)

    # Step 4: Create new unique constraint using batch mode for SQLite
    with op.batch_alter_table('emission_factors', schema=None) as batch_op:
        batch_op.create_unique_constraint('uq_emission_factor_key', ['scope', 'category', 'activity_type', 'country_code', 'year', 'dataset'])
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint('uq_emission_factor_key', 'emission_factors', type_='unique')
    op.drop_index(op.f('ix_emission_factors_dataset'), table_name='emission_factors')
    op.drop_index('idx_factor_dataset', table_name='emission_factors')
    op.create_unique_constraint(op.f('uq_emission_factor_lookup'), 'emission_factors', ['scope', 'category', 'activity_type', 'country_code', 'year', 'method'])
    op.drop_column('emission_factors', 'external_id')
    op.drop_column('emission_factors', 'dataset')
    # ### end Alembic commands ###
